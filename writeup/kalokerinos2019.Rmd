---
title: "Reproduction of Study 2 by Kalokerinos, Erbas, Ceulemans, & Kuppens (2019, Psychological Science)"
author: "Ashish Mehta, ashm@stanford.edu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
---

## Introduction

> [No abstract is needed.]  Each replication project will have a straightforward, no frills report of the study and results.  These reports will be publicly available as supplementary material for the aggregate report(s) of the project as a whole.  Also, to maximize project integrity, the intro and methods will be written and critiqued in advance of data collection.  Introductions can be just 1-2 paragraphs clarifying the main idea of the original study, the target finding for replication, and any other essential information.  It will NOT have a literature review -- that is in the original publication. You can write both the introduction and the methods in past tense.  

In Study 2 of the report "Differentiate to Regulate: Low Negative Emotion Differentiation Is Associated With Ineffective Use but Not Selection of Emotion-Regulation Strategies", Kalokerinos and colleagues, (2019) examined how the ability to make fine-grained distinctions between emotional states (i.e. emotion differentiation) was related to the selection and efficacy of emotion regulation (ER) strategies amidst a high-intensity emotional event. 

The authors initiated students on a nine day experience sampling method (ESM) regimen two days prior to the students receiving a highly-consequential test result. The student participants completed ten surveys per day for the nine days delivered via an application on their smart phones or via a special mobile phone provided by the experimenters. Since the present study concerns regulation *after* and emotional event, only data collected after the results were released are analyzed, resulting in 7 days of ESM data.

The data collected in each survey were:

* ratings of six discrete negative emotions (sad, angry, disappointed, ashamed, anxious, stressed) on a scale of 1-100 in response to thinking about the participant's grade on the exam

* ratings of the use of six ER strategies (rumination, distraction, reappraisal, expressive suppression, social sharing, acceptance) on a 7-point scale

* score on the students' test, (dichotimized in the analysis into passing and failing groups and then aggregated to create a 'percentage of exams passed' variable).

I chose to reproduce this result for two reasons. The first and primary reason is that I am collecting EMA data where I plan to do a similar type of lagged panel model. Reproducing this analysis will provide helpful practice in this type of modeling. The second reason is that I am interested in relationships between emotion differentiation abilities and emotion regulation processes. Thus, the results of this paper are of personal importance to me. 

The Github repository containing all the materials for this reproduction can be found [here](https://github.com/psych251/kalokerinos2019). The original research report PDF can be found [here](https://github.com/psych251/kalokerinos2019/blob/master/original_paper/kalokerinos2019.pdf).

## Methods

<!-- ### Power Analysis -->

<!-- > Original effect size, power analysis for samples to achieve 80%, 90%, 95% power to detect that effect size.  Considerations of feasibility for selecting planned sample size. -->
    
<!-- Since this is an analysis reproduction, rather than a full replication, I will conduct a post-hoc power analysis on the fitted models. -->


### Sample

> Planned sample size and/or termination rule, sampling frame, known demographics if any, preselection rules if any.

The sample for this dataset consisted of first-year Belgian undergraduate students. The planned *N* was 100 participants which would have 80% power to detect a medium effect (*r* = .30, *α* = .05). The final *N* for the study was 101 participants (14 males; age: *M* = 18.64, *SD* = 1.45). Participans were recruited through a university research participation program and through social media. The authors had a predetermined rule for omission of participants with less than 50% completion, but no participants met this criterion so all were included in analysis. Participants were awarded compensation on a basis commensurate with their study completion percentage.



### Materials

> All materials - can quote directly from original article - just put the text in quotations and note that this was followed precisely.  Or, quote directly and just point out exceptions to what was described in the original article.

The materials for the study are taken directly from the original paper and copied below:

> ##### Negative emotion. 
>Six emotions (sad, angry, disappointed, ashamed, anxious, stressed) were assessed on a 100-point scale (1 = not at all, 100 = very much). The item stem was “When you think about your grades right now, how [emotion] are you feeling?” (R~KF~ = .99, R~C~ = .74). In this study, we updated this measure to include emotions relevant to the context of receiving learning outcomes (Pekrun, 2006). We kept “sad,” “angry,” “anxious,” and “stressed” from Study 1, as the former three are also learning-related emotions (Pekrun, 2006), and continuity across studies allowed for comparison. However, differentiation should replicate across the inclusion of different emotions if each of the emotions provides new information. We added “disappointed” and “ashamed” because of their centrality in retrospectively evaluating learning outcomes (Pekrun, 2006).

> ##### Negative-emotion differentiation. 
>As in Study 1, we took the ICC between negative emotions within-person across measurement occasions, applied a Fisher’s z transformation, and then reverse scored it so higher numbers equaled higher differentiation. There were no negative ICCs.

> ##### Emotion-regulation strategies. 
> We assessed six strategies on a 7-point scale (0 = not at all, 6 = very much). The item stem was “Since the last beep, have you . . .” Five strategies from Study 1 were reworded to assess grade-relevant regulation: rumination (“ruminated about your grades?”), distraction (“distracted yourself from your grades and the associated emotions?”), reappraisal (“looked at your grades or the emotions that go with them from another perspective?”), expressive suppression (“suppressed the outward expression of your emotions about your grades?”), and social sharing (“talked to others about your grades and the associated emotions?”). We also included acceptance (“accepted your emotions about your grades the way they are?”).

> ##### Percentage passed. 
> For each subject, participants reported scores out of 20, with 10 and above being a passing grade and below 10 a failing grade. Failing requires retaking the exam later in the year or, in the case of too many failures, termination of enrollment. Given the clear emotional line at passing, we dichotomized scores on each subject as fail (1–9) or pass (10–20) and calculated the percentage of subjects passed across all subjects taken. This percentage variable was highly correlated with mean score out of 20 across exams (*r* = .90), and we found no differences in reported results when using mean score instead of percentage passed. In the baseline survey, we assessed participants' expectations about their upcoming exam grades using the same measure. We used this to compute an expected-percentage-passed variable. Including both expected and actual passing percentage, or the difference between actual and expected passing percentage, did not substantively change our results. Thus, we focus on actual passing percentage.


### Procedure	

> Can quote directly from original article - just put the text in quotations and note that this was followed precisely.  Or, quote directly and just point out exceptions to what was described in the original article.

The procedure for data collection is copied from the original article below:

>Three days before receiving results, participants came to a lab session where they were trained on the ESM protocol. Participants were told that the study was about emotions and exams but were not given details about specific hypotheses. They then completed the ESM phase. On results-release day, within a 2-hr period, students were notified by e-mail that results were available in an online portal and asked to check them immediately. On this day, participants were sent a link to an online survey asking them to report their grade for each subject. For the ESM protocol, participants with a compatible personal Android phone installed mobileQ (*N* = 28). Other participants were given a research-only smartphone (*N* = 73). Participants completed 9 consecutive days of experience sampling: 2 days before the results release and 7 days after. We used a stratified random-interval scheme that sent a random signal within 10 equal intervals between 10:00 a.m. and 10:00 p.m. There was some variability in when results were released: Participants received their results between surveys 21 and 28 of 90. We were interested in regulation in response to results, and thus we included only post-results surveys, meaning that participants received between 63 and 70 surveys (*M* = 68.69). Participants received a signal on average every 71.9 min (*SD* = 29.8) and completed an average of 90.5% of signals (*SD* = 7.8%).

### Analysis Plan

> Can also quote directly, though it is less often spelled out effectively for an analysis strategy section.  The key is to report an analysis strategy that is as close to the original - data cleaning rules, data exclusion rules, covariates, etc. - as possible.  

> **Clarify key analysis of interest here**  You can also pre-specify additional analyses you plan to do.

The data analysis conducted in the original study consisted of two model structures built separately with each of the six emotion regulation strategies, resulting in twelve total models. The description of the data analytic strategy from the original article is copied below:

> #### Data-analytic strategy
> As in Study 1, we used *lme4* (Bates et al., 2015) to fit mixed-effects models and standardized variables for analyses. We ran two-level models, with measurement occasions (*N* = 6,282) nested within persons (*N* = 101). In these models, we included percentage pass as a proxy for the emotional intensity of the stimulus. However, because we did not have the necessary statistical power, we did not estimate a three-way interaction with this variable. Strategies and negative emotion were measured at the occasion level, and differentiation and percentage passed at the person level. We found no substantive differences in either model when person-level negative emotion was included, but we included this variable in Model 1 to replicate Study 1.

> ##### Model 1: emotion differentiation as a predictor of emotion-regulation strategies. 
> In Model 1, we used differentiation, percentage passed, and negative emotion, which were grand-mean centered, to predict each strategy separately (six models). We included random intercepts per participant.

> ##### Model 2: Emotion Differentiation × Emotion Regulation Strategies predicting negative emotion. 
> In Model 2, we used differentiation, regulation, their cross-level interaction, and percentage passed to predict negative emotion (separately for each strategy; six models). We included lagged negative emotion (at the previous time point) to model emotional change, again excluding overnight lags. We person-mean-centered regulation and lagged emotion and grand-mean-centered differentiation and percentage passed. We included random intercepts per participant. For each participant, we included random slopes for regulation and lagged emotion, and we allowed these slopes to covary. There was one exception to this strategy: The acceptance model would not converge until we removed the random slope for acceptance, so we report this model with this random slope omitted.

### Differences from Original Study

> Explicitly describe known differences in sample, setting, procedure, and analysis plan from original study.  The goal, of course, is to minimize those differences, but differences will inevitably occur.  Also, note whether such differences are anticipated to make a difference based on claims in the original article or subsequent published research on the conditions for obtaining the effect.

Since this is an analysis reproduction, the data will be exactly the same. I plan to run this analysis using *lme4* just as the authors did. I will also conduct the same analysis using the *brms* Bayesian Regression package in R so I can compare the credible intervals and expected values of the posterior distributions with the confidence intervals and point estimates given by the *lme4* linear mixed model framework.


## Results


### Data preparation

> Data preparation following the analysis plan.
	

#### Load Relevant Libraries and Functions
```{r, message=FALSE, warning=FALSE, results='hide'}
# rm(list = ls())
library(tidyverse)
library(haven)
library(psych)
library(here)
library(broom.mixed)
library(glue)
library(lmerTest)
library(riclpmr)
library(lavaan)
theme_set(theme_minimal())

```


#### Import data
```{r}
df_raw <- read_sav(here("data/Study 2_exam.sav"))

```


#### Prepare data for analysis - create columns etc.

##### Column names of each emotion valence category
```{r}
neg_emo_cols <- c("emotion_sad", "emotion_angry", "emotion_disapp",
                  "emotion_ashamed", "emotion_anxious", "emotion_stressed")
pos_emo_cols <- c("emotion_proud", "emotion_happy", "emotion_content", "emotion_relief")
er_strategy_cols <- c("ER_acceptance", "ER_rumination", "ER_reapp", 
                      "ER_supp", "ER_soc_sharing", "ER_distraction")
```

##### Data munging

Exclude all emotion reports from prior to the release of exam results
```{r}
df_raw_post_exam <- df_raw %>%
  # ---- Keep only reports after exam results were received ---- #
  filter(exam_beepnum >= 0)
```


Here I am creating useful columns. Most of these are either grand-mean scaled (varname_sc), grand-mean centered (varname_c), person-mean scaled (varname_psc), or lagged (varname_lag).
```{r}
df_clean <- df_raw_post_exam  %>% 
  # ---- Create pos/neg emotion intensity composite scores ---- #
  mutate(
    neg_emo_comp = rowMeans(df_raw_post_exam[,neg_emo_cols], na.rm = T),
    pos_emo_comp = rowMeans(df_raw_post_exam[,pos_emo_cols], na.rm = T),
    perc_pass = perc_pass*100
  ) %>% 
  # ---- Create person level mean negative emotion score (covariate in models) ---- # 
  group_by(Participant) %>% 
  mutate(person_neg_emo_mean = mean(neg_emo_comp, na.rm = T)) %>% 
  ungroup %>% 
  # ---- Create lagged emotion and strategy vars ---- #
  group_by(Participant, beepday) %>% 
  mutate_at(vars(matches("emo|^ER_")), 
            list(lag = ~  lag(.))) %>% 
  ungroup %>% 
  # ---- Person scale emotion and strategy vars ---- #
  group_by(Participant) %>% 
  mutate_at(vars(matches("emo|^ER_"), -matches("_sc$|_c$|_psc$|_pc$")), 
            list(pc = ~scale(., T, F))) %>% 
  mutate_at(vars(matches("emo|^ER_"), -matches("_sc$|_c$|_psc$|_pc$")), 
            list(psc = ~scale(.))) %>% 
  ungroup %>% 
  # ---- Create grand mean centered emotion and strategy vars ---- #
  mutate_at(vars(matches("emo|^ER_|^perc_pass$"), -matches("_sc$|_c$")), 
            list(c = ~scale(., center=T, scale=F))) %>%
  # ---- Create grand mean scaled emotion and strategy vars ---- #
  mutate_at(vars(matches("emo|^ER_|^perc_pass$"), -matches("_sc$|_c$")), 
            list(sc = ~scale(.)))
  
```



##### Function to calculate ICC stats in dataframe row form
```{r}
compute_icc <- function(dat) {
  dat %>%
    select(neg_emo_cols) %>% 
    irr::icc(model="twoway", unit = "average") %>%       
    unlist %>%        
    t %>%              
    as_tibble %>%      
    select(              
      stimuli = subjects,
      raters, 
      icc = value,       
      lbound, 
      ubound
    ) %>%
    mutate_at(vars(stimuli, raters), as.integer) %>% 
    mutate_at(vars(icc:ubound), as.numeric)
}
```

##### Create dataframe of ICCs for each participant and Fisher-z transform
```{r}
icc_df <- df_clean %>%
  group_by(Participant) %>%              
  nest() %>%                             
  mutate(icc = map(data, compute_icc)) %>%    
  unnest(icc) %>%                        
  select(-data) %>% 
  ungroup %>% 
  mutate(
    icc_fz = fisherz(icc),
    ed_score = icc_fz*-1,
    ed_score_class = case_when(
      ed_score > (mean(ed_score, na.rm = T) + sd(ed_score)) ~ "> +1 SD",
      ed_score < (mean(ed_score, na.rm = T) - sd(ed_score)) ~ "< -1 SD"
      ) 
    )
  
```

##### Merge ICC dataframe to full data
```{r}
df <- icc_df %>% 
  select(Participant, icc, ed_score, ed_score_class) %>% 
  right_join(df_clean, by="Participant") %>% 
  mutate(ed_score_sc = scale(ed_score))

```

##### Exclude incomplete cases
Since the smartphone app requires the user to fill out all responses to continue, any incomplete regulation strategy indicates an incomplete response.
```{r}
df <- df %>%
  filter(!is.na(ER_reapp))
```


### Initial data viz


##### Visualizing participant compliance
```{r}
df %>% 
  group_by(Participant) %>% 
  summarize(proportion_complete = sum(!is.na(ExecutionTime))/90) %>% 
  ungroup %>% 
  ggplot(aes(x = proportion_complete)) + 
  geom_histogram(binwidth = .02) +
  # geom_density() + 
  labs(x = "Proportion complete", x = "Number of participants")
```

#### Visualizing emotion characteristics

##### Create a long dataframe for visualizing emotion characteristics
```{r}
df_emotion_long <- df %>% 
  group_by(Participant, perc_pass) %>% 
  summarize_at(vars(starts_with("emotion_"), 
                    -matches("_c$|_sc$|_psc$|_lag|_pc$")), 
               mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -perc_pass), 
               names_to = "emotion_type", values_to = "emotion_rating") %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean)) %>% 
  left_join(select(icc_df, Participant, ed_score)) %>% 
  mutate(ed_score_class = case_when(
    ed_score > (mean(.$ed_score, na.rm = T) + sd(.$ed_score)) ~ "> +1 SD",
    ed_score < (mean(.$ed_score, na.rm = T) - sd(.$ed_score)) ~ "< -1 SD",
    TRUE ~ "</> 1 SD"
  ))
```

##### To what degree did people experience different emotions?
```{r}
df %>% 
  group_by(Participant) %>% 
  summarize_at(vars(starts_with("emotion_"), 
                    -matches("_c$|_sc$|_psc$|_lag|_pc")), 
               mean, na.rm=T) %>% 
  pivot_longer(cols = -Participant, names_to = "emotion_type", values_to = "emotion_rating") %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean)) %>% 
  
  ggplot(aes(x = emotion_type, y = emotion_rating)) +
  geom_bar(stat="summary") +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "Emotion type", y = "Mean emotion intensity")
  
```

##### What does the variance across individuals look like?
Each participant's mean is plotted with a black point and 95% CI overlaying the raw data in color. The mean of participant means is represented with a dotted line.
```{r}
mean_neg_emo <- df %>% 
  group_by(Participant) %>% 
  summarize(mean = mean(neg_emo_comp, na.rm = T)) %>% 
  summarize(mean = mean(mean)) %>% 
  unlist


df %>% 
  ggplot(aes(x = factor(Participant), y = neg_emo_comp, color = factor(Participant))) +
  geom_point(position = position_jitter(0), alpha = .4, size = .6) +
  stat_summary(fun.data = "mean_cl_boot", size = .2, color = "black") +
  geom_hline(yintercept = mean_neg_emo, linetype = "dotted") +
  theme(legend.position = "none", axis.text.x=element_blank()) +
  labs(x = "Participant", y = "Negative emotion")
```


##### How were different emotions related to the percentage of exams passed?
```{r}
df_emotion_long  %>% 
  ggplot(aes(x = perc_pass, y = emotion_rating, color = emotion_type)) +
  geom_point(aes(shape = ed_score_class), alpha = .4, position = position_dodge(w =10)) +
  geom_smooth(se=F, size = .4) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "Proportion of exams passed", 
       y = "Emotion intensity", 
       color = "", 
       size = "Differentiation score")
```

```{r, fig.asp=2}
df_emotion_long  %>% 
  ggplot(aes(x = perc_pass, y = emotion_rating, color = emotion_type)) +
  facet_grid(emotion_type ~.) +
  geom_jitter(alpha = .2) +
  geom_smooth() +
  theme(axis.text.x = element_text(angle=90)) +
  labs(y = "Emotion intensity", 
       x = "Percantage of exams passed",
       color = "")
  
```

##### How did different emotions unfold over time?
```{r}
df %>% 
  filter(exam_beepnum >= 0) %>% 
  group_by(Participant) %>% 
  ggplot(aes(x = exam_beepnum, y = neg_emo_comp)) + 
  geom_jitter(alpha = .2, size = .4) +
  geom_smooth() + 
  geom_smooth(method="lm", linetype="dotted") +
  labs(x = "EMA beep number", y = "Negative emotion mean")

perc_pass_summary <- df %>% 
  group_by(Participant) %>% 
  summarize(perc_pass = mean(perc_pass, na.rm = T)) %>% 
  summarize(mean = mean(perc_pass, na.rm = T),
            sd = sd(perc_pass, na.rm = T))

df %>% 
  group_by(Participant, exam_beepnum) %>% 
  summarize_at(vars(starts_with("emotion_"), 
                    -matches("_sc$|_c$|_psc$|_pc$|_lag$")), 
               mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -exam_beepnum), 
               names_to = "emotion_type", 
               values_to = "emotion_rating") %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean))  %>% 
  
  ggplot(aes(x = exam_beepnum, y = emotion_rating, color = emotion_type)) +
  geom_jitter(alpha = .2, size = .1) +
  geom_smooth(se=F) +
  labs(x = "Ping number relative to exam result", y = "Emotion intensity", color = "")
```

##### Emotion over time broken down by emotion type
```{r, fig.asp=2}
df %>% 
  group_by(Participant, exam_beepnum) %>% 
  summarize_at(vars(starts_with("emotion_"), -matches("_sc$|_c$|_psc$|_pc$|_lag")), mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -exam_beepnum), names_to = "emotion_type", values_to = "emotion_rating") %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean))  %>% 
  
  ggplot(aes(x = exam_beepnum, y = emotion_rating, color = emotion_type)) +
  facet_grid(emotion_type ~.) +
  geom_jitter(alpha = .1, size = .2) +
  geom_smooth() +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "Ping number relative to exam result", y = "Emotion intensity")

```


##### What is the relationship between percentage of exams passed and negative emotion? 
Note that the variance around negative emotion increases starkly as people performed worse on exams. This could pose a problem for linear modeling.
```{r}

df %>% 
  group_by(Participant, perc_pass) %>% 
  summarize_at(vars(starts_with("emotion_"), -matches("_sc$|_c$|_psc$|_pc$|_lag")), mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -perc_pass), 
               names_to = "emotion_type", values_to = "emotion_rating") %>% 
  filter(emotion_type %in% neg_emo_cols) %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean))  %>% 
  summarize(mean_neg_emo = mean(emotion_rating),
            perc_pass = perc_pass[1]) %>% 
  
  ggplot(aes(x = perc_pass, y = mean_neg_emo)) +
  geom_jitter(alpha = .2) +
  geom_smooth() +
  labs(x = "Percentage of exams passed", y = "Mean negative emotion")
```


##### How is negative emotion differentiation related to the amount of negative emotion experienced?

This shows an interesting pattern, however, I'm not sure what to make of this since the emotion differentiation score is derived from emotion intensity.
```{r}
df %>% 
  # ---- get a mean emotion score for each emotion for each participant ---- #
  group_by(Participant, ed_score) %>% 
  summarize_at(vars(starts_with("emotion_"), 
                    -matches("_sc$|_c$|_psc$|_pc$|_lag$")),
               mean, na.rm=T) %>% 
  select(-pos_emo_cols) %>% 
  # ---- elongate ---- #
  pivot_longer(cols = c(-Participant, -ed_score), 
               names_to = "emotion_type", values_to = "emotion_rating") %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean)) %>% 
  
  ggplot(aes(x = ed_score, y = emotion_rating, color = emotion_type)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "loess", se=F) +
  geom_smooth(aes(group = 1), linetype = "dotted") +
  labs(y = "Emotion intensity", x = "Emotion differentiation score", color = "Negative emotion")
```


#### Visualizing regulation characteristics

##### To what degree did people use different strategies?
Acceptance has a way outsized share of strategy usage. It is difficult to measure acceptance in this context since it can easily be misintepreted as accepting your exam scores rather than accepting negative emotions. In a colloquial sense, one might be more accustomed to speaking about how much they accept a situation, rather than how much they accept concomitant emotional sensation of a situation. This confusion is less of a concern for other strategies where the colloquial interpretation more closely aligns with the emotion regulation construct.
```{r}
df %>% 
  group_by(Participant) %>% 
  summarize_at(vars(starts_with("ER_"),
                    -matches("_sc$|_c$|_psc$|_pc$|_lag$")),
               mean, na.rm=T) %>% 
  pivot_longer(cols = -Participant, 
               names_to = "strategy_type", values_to = "strategy_rating") %>% 
  mutate(strategy_type = str_replace_all(strategy_type, "ER_", ""),
         strategy_type = reorder(strategy_type, strategy_rating, mean))  %>% 
  mutate(strategy_type=recode(strategy_type,
    "rumination" = "Rumination",
    "reapp" = "Reappraisal",
    "soc_sharing" = "Social sharing",
    "acceptance" = "Acceptance",
    "distraction" = "Distraction",
    "supp" = "Suppression"
  )) %>% 
  
  ggplot(aes(x = strategy_type, y = strategy_rating)) +
  stat_summary(fun.data = "mean_cl_boot", size = .4) +
  geom_jitter(alpha = .2, size = .5) +
  theme(axis.text.x = element_text(angle=90)) +
  scale_y_continuous(limits = c(0,6)) +
  labs(x = "", 
       y = "Mean strategy use")
  
```

##### How were different strategies related to the percentage of exams passed?
This strengthens my hypothesis that acceptance may be misinterpreted by the participants since we see a unique positive relationship with the usage of acceptance and the percentage of exams passed. We see this cluster of participants endorsing maximum acceptance usage when they passed 100% of exams and would not be expected to have any negative emotion to regulate at all. If they were misinterpreting the question to mean acceptance of their exam grade however, this pattern would be expected.
```{r}
df %>% 
  group_by(Participant, perc_pass) %>% 
  summarize_at(vars(starts_with("ER_"),
                    -matches("_sc$|_c$|_psc$|_pc$|_lag$")), 
               mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -perc_pass), 
               names_to = "strategy_type", 
               values_to = "strategy_rating") %>% 
  mutate(strategy_type = str_replace_all(strategy_type, "ER_", ""),
         strategy_type = reorder(strategy_type, strategy_rating, mean))  %>% 
  
  ggplot(aes(x = perc_pass, y = strategy_rating, color = strategy_type)) +
  geom_jitter(alpha = .2) +
  geom_smooth(method = "lm", se=F) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "Percentage of exams passed", 
       y = "Strategy usage",
       color = "Strategy")

```

##### How is mean strategy usage related to the amount of negative emotion experienced?
Again we see an anomaly in the acceptance category where the most "accepting" participants were those experiencing no negative emotion. 
```{r}
df %>% 
  group_by(Participant) %>% 
  summarize_at(vars(starts_with("ER_"),
                    -matches("_sc$|_c$|_psc$|_pc$|_lag$"),
                    neg_emo_comp), 
               mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -neg_emo_comp), 
               names_to = "strategy_type", 
               values_to = "strategy_rating") %>% 
  mutate(strategy_type = str_replace_all(strategy_type, "ER_", ""),
         strategy_type = reorder(strategy_type, strategy_rating, mean))  %>% 
  
  ggplot(aes(x = neg_emo_comp, y = strategy_rating, color = strategy_type)) +
  geom_jitter(alpha = .2) +
  geom_smooth(method = "lm", se=F) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "Mean participant negative emotion experienced", 
       y = "Mean participant strategy usage",
       color = "Strategy")

```

##### Does ED score predict use of strategies?
```{r, fig.asp=1.5}
df %>% 
  pivot_longer(cols = er_strategy_cols, 
               names_to = "strategy_type", 
               values_to = "strategy_rating") %>% 
  group_by(Participant, strategy_type, ed_score) %>% 
  summarize(strategy_usage_mean = mean(strategy_rating, na.rm = T)) %>% 
  ggplot(aes(x = ed_score, y = strategy_usage_mean, color = strategy_type)) +
  # facet_grid(strategy_type~.) +
  geom_jitter(alpha = .2) +
  geom_smooth(method = "lm") +
  geom_smooth(se=F, linetype = "dashed", size = .3) +
  labs(x = "Emotion differentiation score", 
       y = "Mean strategy use",
       color = "")

```

##### How does emotion intensity at time t-1 predict ER strategy at time t?
```{r}
df %>% 
  pivot_longer(cols = er_strategy_cols, 
               names_to = "strategy_type", 
               values_to = "strategy_rating")  %>% 
  mutate(strategy_type=recode(strategy_type,
    "ER_rumination" = "Rumination",
    "ER_reapp" = "Reappraisal",
    "ER_soc_sharing" = "Social sharing",
    "ER_acceptance" = "Acceptance",
    "ER_distraction" = "Distraction",
    "ER_supp" = "Suppression"
  )) %>% 
  
  ggplot(aes(x = neg_emo_comp_lag, y = strategy_rating, color = strategy_type)) +
  # facet_grid(strategy_type~.) +
  geom_jitter(alpha = .1, size = .5) +
  geom_smooth(method = "lm") +
  geom_smooth(se=F, linetype = "dashed", size = .3) +
  labs(x = "Emotion intensity at time t-1", y = "Strategy use at time t", color = "")

```


### Confirmatory analysis

> The analyses as specified in the analysis plan.  

##### helper functions

Function for formatting output table
```{r}

table_out <- function(result_df){
  result_df %>% 
    filter(effect == "fixed") %>% 
    mutate(ci = glue("[{round(estimate-(std.error*1.96),2)}, {round(estimate+(std.error*1.96),2)}]")) %>% 
    select(-df, -effect, -group, -statistic) %>% 
    mutate_if(is.numeric, round, digits = 3) %>% 
    mutate(term = str_replace(term, "ed_score", "Differentiation")) %>% 
    mutate(term = str_replace(term, "_pc", "")) %>% 
    mutate(term = str_replace(term, "perc_pass", "Percentage passed")) %>% 
    mutate(term = str_replace(term, "person_neg_.*", "Negative emotion")) %>% 
    mutate(term = str_replace(term, ".*emo.*lag.*", "Lagged emotion")) %>% 
    mutate(term = str_replace(term, "ER_", "")) %>% 
    mutate(term = str_replace(term, ":", " x ")) %>% 
    mutate(term = str_replace(term, "_sc", "")) %>% 
    mutate(ordering = case_when(
      strategy == "rumination" ~ "1",
      strategy == "distraction" ~ "2",
      strategy == "reapp" ~ "3",
      strategy == "acceptance" ~ "4",
      strategy == "supp" ~ "5",
      strategy == "soc_sharing" ~ "6"
    )) %>% 
    arrange(ordering) %>% 
    select(-ordering)
}


```

Function to format output of model building functions
Creates a dataframe of model estimates and a label for which strategy is being tested
```{r}
format_model <- function(x){
  x[[2]] %>% 
    broom.mixed::tidy() %>%
    mutate(strategy = x[[1]],
           strategy = str_replace(strategy, "ER_|_pc_sc", "")) %>%
    select(strategy, everything())
}
```

##### Start the modeling ...

###### Model 1: Predicting strategy selection from differentiation score
```{r}
build_model1 <- function(x){
  model_str_eval <- glue("
  lmer({x} ~ ed_score_sc + 
         perc_pass_sc + 
         person_neg_emo_mean_sc +
         (1 | Participant), df)")
  strat <- str_replace_all(x, "_sc|ER_", "")
  list(strat, eval(parse(text = model_str_eval)))
}

result_1 <- map(paste0(er_strategy_cols, "_sc"), build_model1)
result_1_df <- map(result_1, format_model) %>% 
  bind_rows


# assign models to environment variables, becomes useful when creating the figure reproduction
map(result_1, ~assign(x = paste0(.[[1]], "_mod1"), # var name: "strategy_mod1"
                      value = .[[2]],
                      pos = 1)) # global environment
```

Model output
```{r}
result_1_df %>% sjPlot::tab_df(digits = 3)
```

Write results to disk
```{r}
result_1_out <- result_1_df %>% 
  table_out
write_csv(result_1_out, here("writeup/model1_table.csv"))
```

###### Model 2: Predicting efficacy from interaction of strategy usage and differentiation score
```{r}
build_model2 <- function(x){
  model_str_eval <- glue("
  lmer(neg_emo_comp_sc ~ ed_score_sc*{x} + 
  perc_pass_sc + neg_emo_comp_lag_pc_sc +
  ({x} + neg_emo_comp_lag_pc_sc | Participant), df)")
  strat <- str_replace_all(x, "_pc|_sc|ER_", "")
  list(strat, eval(parse(text = model_str_eval)))
}


result_2 <- map(paste0(er_strategy_cols, "_pc_sc"), build_model2)
result_2_df <- map(result_2, format_model) %>% 
  bind_rows

# assign models to variables
map(result_2, ~assign(x = paste0(.[[1]], "_mod2"), # var name: strategyvar_mod2
                      value = .[[2]],
                      pos = 1)) # global environment
```

Model output
```{r}
result_2_df %>% sjPlot::tab_df(digits = 3)
```

Write results to disk
```{r}
result_2_out <- result_2_df %>% 
  table_out
write_csv(result_2_out, here("writeup/model2_table.csv"))
```

<!-- ### Post-hoc power analysis -->
<!-- ```{r} -->
<!-- # (pwr_distraction_m1 <- powerSim(distraction_mod1, seed = 1234, nsim = 10)) -->

<!-- V_pid <- .747^2 -->
<!-- V_strat_pid <- 0.069^2 -->
<!-- V_emolag_pid <- 0.077^2 -->
<!-- V_resid <- 0.316^2 -->

<!-- intcpt <- -0.003 -->
<!-- B_ed <- -0.035 -->
<!-- B_strat <- 0.025 -->
<!-- B_pass <- -0.575 -->
<!-- B_emolag <- 0.162 -->
<!-- B_ed_x_strat <- -0.026 -->

<!-- # pid_means <- rnorm() -->




<!-- ``` -->



### Plotting the models (reproduction of manuscript figure)

#### Get stats needed to plug into simple slopes calculator
Use case 3 calculator at this link: [simple slopes calculator](http://www.quantpsy.org/interact/hlm2.htm).

##### Variance and covariances 

Acceptance
```{r}
vcov(acceptance_mod2) 
coef(acceptance_mod2)$Participant$`(Intercept)` %>% mean
coef(acceptance_mod2)$Participant$ER_acceptance_pc_sc %>% mean
coef(acceptance_mod2)$Participant$ed_score_sc %>% mean
coef(acceptance_mod2)$Participant$`ed_score_sc:ER_acceptance_pc_sc` %>% mean
```


Rumination
```{r}
vcov(rumination_mod2)
coef(rumination_mod2)$Participant$`(Intercept)` %>% mean
coef(rumination_mod2)$Participant$ER_rumination_pc_sc %>% mean
coef(rumination_mod2)$Participant$ed_score_sc %>% mean
coef(rumination_mod2)$Participant$`ed_score_sc:ER_rumination_pc_sc` %>% mean
```


Social sharing
```{r}
vcov(soc_sharing_mod2)
coef(soc_sharing_mod2)$Participant$`(Intercept)` %>% mean
coef(soc_sharing_mod2)$Participant$ER_soc_sharing_pc_sc %>% mean
coef(soc_sharing_mod2)$Participant$ed_score_sc %>% mean
coef(soc_sharing_mod2)$Participant$`ed_score_sc:ER_soc_sharing_pc_sc` %>% mean
```


Distraction
```{r}
vcov(distraction_mod2)
coef(distraction_mod2)$Participant$`(Intercept)` %>% mean
coef(distraction_mod2)$Participant$ER_distraction_pc_sc %>% mean
coef(distraction_mod2)$Participant$ed_score_sc %>% mean
coef(distraction_mod2)$Participant$`ed_score_sc:ER_distraction_pc_sc` %>% mean
```

##### Create a dataframe of simple slope coefficients that are unstandardized
```{r}
ss_coefs_df <- read_csv(here("data/simple_slopes_coefficients.csv")) %>% 
  pivot_wider(names_from = "term", values_from = "coefficient")

strat_sds <- df %>% 
  select(which(names(df) %in% ss_coefs_df$strategy)) %>%
  pivot_longer(cols = everything(), names_to = "strategy", values_to = "value") %>% 
  group_by(strategy) %>% 
  summarize(strat_sd = sd(value)) %>% 
  ungroup

neg_emo_sd <- sd(df$neg_emo_comp)
neg_emo_mean <- mean(df$neg_emo_comp)



# unstandardize the coefficients and create separate columns for different line segments
ss_coefs_df_unstd <- ss_coefs_df %>% 
  left_join(strat_sds) %>% 
  mutate(slope_unstd = slope * (neg_emo_sd/strat_sd),
         intercept_unstd = neg_emo_mean + (intercept * neg_emo_sd)) %>% 
  mutate(strategy_type=recode(strategy,
    "ER_rumination_pc" = "Rumination",
    "ER_soc_sharing_pc" = "Social sharing",
    "ER_acceptance_pc" = "Acceptance",
    "ER_distraction_pc" = "Distraction",
  )) %>% 
  mutate(strategy_type = fct_relevel(strategy_type,
                                     "Rumination","Distraction","Acceptance","Social sharing"),
         sd_group = dplyr::recode(sd_group,
                                  "hi" = "High ED (+1 SD)",
                                  "lo" = "Low ED (-1 SD)"),
         sd_group = fct_relevel(sd_group, "Low ED (-1 SD)"))
```


##### how does each strategy predict negative emotion with emotion differentiation moderator? (Figure 2 from manuscript)
```{r}
plot_df <- df %>%
  select(Participant,
         ed_score,
         ed_score_class,
         matches("ER_.*_pc_sc$"),
         -matches("_c$|_psc$|_lag|_pc$"),
         neg_emo_comp) %>%
  pivot_longer(cols = c(-Participant, -neg_emo_comp, -ed_score, -ed_score_class),
               names_to = "strategy_type",
               values_to = "strategy_rating") %>%
  mutate(
    ed_score = scale(ed_score, T, F),
    strategy_type = str_replace_all(strategy_type, "ER_", ""),
    strategy_type = reorder(strategy_type, strategy_rating, mean)) %>% 
  mutate(
    strategy_type = dplyr::recode(
      strategy_type,
      "rumination_pc_sc" = "Rumination",
      "reapp_pc_sc" = "Reappraisal",
      "soc_sharing_pc_sc" = "Social sharing",
      "acceptance_pc_sc" = "Acceptance",
      "distraction_pc_sc" = "Distraction",
      "supp_pc_sc" = "Suppression")
  ) %>% 
  mutate(strategy_type = fct_relevel(strategy_type,
                                     "Rumination","Distraction","Acceptance","Social sharing")) %>% 
  filter(strategy_type %in% c("Rumination","Distraction","Acceptance","Social sharing")) 


plot_df  %>% 
  ggplot(aes(x = strategy_rating, y = neg_emo_comp)) +
  # individual data points
  geom_jitter(aes(color = ed_score), alpha = .5, size = .2) +
  # line segments with 3 standard deviations on x axis
  geom_segment(aes(
    x =    0 - (strat_sd*3),
    xend = 0 + (strat_sd*3),
    y =    intercept_unstd + (slope_unstd * (0 - (strat_sd * 3))),
    yend = intercept_unstd + (slope_unstd * (0 + (strat_sd * 3))),
    linetype = sd_group
    ), data = ss_coefs_df_unstd) +
  # line segments between 3-6 standard devs on x axis
  geom_segment(aes(
    x =    0 - (strat_sd*6),
    xend = 0 + (strat_sd*6),
    y =    intercept_unstd + (slope_unstd * (0 - (strat_sd * 6))),
    yend = intercept_unstd + (slope_unstd * (0 + (strat_sd * 6)))
    ), linetype = "dotted", data = ss_coefs_df_unstd) +
  # formatting
  facet_wrap(~strategy_type) +
  coord_cartesian(xlim = c(-5, 5)) +
  scale_x_continuous(breaks = seq(-5,5,1)) +
  scale_colour_gradient2(low = "red", mid = "lightcyan", high = "blue") +
  labs(x = "Strategy usage",
       y = "Negative emotion intensity", 
       color = "Emotion differentiation",
       linetype = "") + 
  theme(panel.spacing = unit(.1, "lines"))


  
```

##### Original Figure 2
![Kalokerinos figure 2](`r here::here("writeup/figure2.png")`)
*Side-by-side graph with original graph is ideal here*

### Exploratory analyses

> Any follow-up analyses desired (not required).

#### Looking at relationship temporal relations between negative emotion and reappraisal
It's important to note here that the question asking about reappraisal is *retrospective*, (since last EMA ping), and the question asking about emotion intensity is current. Thus, reappraisal and negative emotion measured in the same survey are referring to reappraisal at time t-1 and emotion at time t. As a result, when we look at the effect of reappraisal on subsequent emotion, we do not need to use any lagged measurements. When we look at the effect of emotion on subsequent reappraisal usage, we need to use a lagged emotion measurement.

#### Create a simpler dataframe for modeling temporal relationships
Here I am making a simpler dataframe for modeling temporal relationships. I am also limiting this to only measurements taken on the day the test result was received. 
```{r}

df_mod_long <- df %>%
  mutate(t = exam_beepnum+1,
         t_num = as.numeric(t)) %>% 
  filter(t <= 10) %>%
  select(Participant, t, t_num, perc_pass,
         ER_reapp_sc, ER_reapp_lag_sc,
         neg_emo_comp_sc, neg_emo_comp_lag_sc) %>%
  mutate(t = paste0("t", t),
         # perc_pass = scale(perc_pass),
         ) %>%
  rename("neg" = "neg_emo_comp_sc",
         "neg_lag" = "neg_emo_comp_lag_sc",
         "reap" = "ER_reapp_sc",
         "reap_lag" = "ER_reapp_lag_sc") 

df_mod <- df_mod_long %>% 
  pivot_wider(id_cols = c("Participant", "perc_pass"),
              names_from = "t", values_from = c("neg", "neg_lag", "reap", "reap_lag"))
```



#### Plotting the temporal relationships between negative emotion and reappraisal broken down by time point
If we look at the relation between lagged neg emotion and ER and vice versa, it goes in the opposite direction at t1 and t2, but then stays in the expected direction after that. I will experiment with removing these time points from the modeling later on. It is also super interesting that the relationship between reappraisal and subsequent negative emotion seems to increase as time goes on. This is super puzzling. At first glance, it is counterintuitive that there should be a positive relationship at all between use of reappraisal and subsequent emotion since you would expect reappraisal to dampen negative emotion. It's hard to make anything of this since we are not controlling for prior negative emotion here. If someone has a greater degree of emotion at time t-1 they will likely use reappraisal more, but also have higher emotion at time t.
```{r}
df_mod_long %>% 
  ggplot(aes(y = reap, x = neg_lag)) + 
  geom_point(position = position_jitter(.2), alpha = .4) +
  geom_smooth(aes(color = t), method="gam", se = F, size = .9) 

df_mod_long %>% 
  ggplot(aes(x = reap, y = neg)) + 
  geom_point(position = position_jitter(.2), alpha = .4) +
  geom_smooth(aes(color = t), method="gam", se = F, size = .9) 

```

Here we are exploring the relationship between reappraisal and subsequent negative emotion. When controlling for prior negative emotion, there does not appear to be any relationship at all. This could indicate that in the first day after receiving their result, reappraisal may be inaccessible. I should check if this result holds for distraction which is known to be more accessible in times of high intensity negative emotion. There is very strong autocorrelation in the negative emotion.
```{r}
fit_neg <- lmer(neg ~ reap + neg_lag + (1|Participant), df_mod_long)
coef_neg <- coef(fit_neg)

df_mod_long %>% 
  ggplot(aes(x = reap, y = neg)) + 
  geom_jitter(width = .1, alpha = .2) +
  geom_abline(intercept = coef_neg$Participant$`(Intercept)`,
              slope = coef_neg$Participant$reap, size = .2)
summary(fit_neg)
```

Here we see a positive relationship between negative emotion and subsequent reappraisal usage as expected.
```{r}
fit_er <- lmer(reap ~ neg_lag + reap_lag + (1|Participant), df_mod_long)
coef_er <- coef(fit_er)
df_mod_long %>% 
  ggplot(aes(y = reap, x = neg_lag)) + 
  geom_jitter(width = .1, alpha = .2) +
  geom_abline(intercept = coef_er$Participant$`(Intercept)`,
              slope = coef_er$Participant$`neg_lag`, size = .2) +
  geom_abline(intercept = mean(coef_er$Participant$`(Intercept)`),
              slope = mean(coef_er$Participant$`neg_lag`), 
              color = "red")
summary(fit_er)



```


```{r}
riclpmModel_not1t2 <- 
'

neg_lt =~ 1*neg_t3 + 1*neg_t4 + 
          1*neg_t5 + 1*neg_t6 + 
          1*neg_t7 + 1*neg_t8 + 
          1*neg_t9 + 1*neg_t10
          
reap_lt =~ 1*reap_t3 + 1*reap_t4 + 
          1*reap_t5 + 1*reap_t6+ 
          1*reap_t7 + 1*reap_t8 + 
          1*reap_t9 + 1*reap_t10
          
#intercepts
neg_t3 ~ mu3 *1
neg_t4 ~ mu4 *1 
neg_t5 ~ mu5 *1
neg_t6 ~ mu6 *1
neg_t7 ~ mu7 *1 
neg_t8 ~ mu8 *1
neg_t9 ~ mu9 *1
neg_t10 ~ mu10*10

reap_t3 ~ pi3 *1
reap_t4 ~ pi4 *1
reap_t5 ~ pi5 *1
reap_t6 ~ pi6 *1
reap_t7 ~ pi7 *1
reap_t8 ~ pi8 *1
reap_t9 ~ pi9 *1
reap_t10~ pi10*1

neg_lt ~~ neg_lt #variance
reap_lt ~~ reap_lt #variance
neg_lt ~~ reap_lt #covariance

# latent vars for AR and cross-lagged effects
# each factor loading set to 1
neg_lt3 =~ 1*neg_t3 
neg_lt4 =~ 1*neg_t4  
neg_lt5 =~ 1*neg_t5 
neg_lt6 =~ 1*neg_t6 
neg_lt7 =~ 1*neg_t7  
neg_lt8 =~ 1*neg_t8 
neg_lt9 =~ 1*neg_t9 
neg_lt10=~ 1*neg_t10

reap_lt3 =~ 1*reap_t3 
reap_lt4 =~ 1*reap_t4 
reap_lt5 =~ 1*reap_t5 
reap_lt6 =~ 1*reap_t6 
reap_lt7 =~ 1*reap_t7 
reap_lt8 =~ 1*reap_t8 
reap_lt9 =~ 1*reap_t9 
reap_lt10=~ 1*reap_t10


# regressions
neg_lt10 ~ alpha*neg_lt9 + beta*reap_lt10
neg_lt9  ~ alpha*neg_lt8 + beta*reap_lt9
neg_lt8  ~ alpha*neg_lt7 + beta*reap_lt8
neg_lt7  ~ alpha*neg_lt6 + beta*reap_lt7
neg_lt6  ~ alpha*neg_lt5 + beta*reap_lt6
neg_lt5  ~ alpha*neg_lt4 + beta*reap_lt5
neg_lt4  ~ alpha*neg_lt3 + beta*reap_lt4

reap_lt10 ~ delta*reap_lt9 + gamma*neg_lt9
reap_lt9  ~ delta*reap_lt8 + gamma*neg_lt8
reap_lt8  ~ delta*reap_lt7 + gamma*neg_lt7
reap_lt7  ~ delta*reap_lt6 + gamma*neg_lt6
reap_lt6  ~ delta*reap_lt5 + gamma*neg_lt5
reap_lt5  ~ delta*reap_lt4 + gamma*neg_lt4
reap_lt4  ~ delta*reap_lt3 + gamma*neg_lt3

neg_lt ~ perc_pass

# variance
neg_lt3 ~~ neg_lt3
neg_lt4 ~~ u4 *neg_lt4 
neg_lt5 ~~ u5 *neg_lt5 
neg_lt6 ~~ u6 *neg_lt6 
neg_lt7 ~~ u7 *neg_lt7 
neg_lt8 ~~ u8 *neg_lt8 
neg_lt9 ~~ u9 *neg_lt9 
neg_lt10~~ u10*neg_lt10

reap_lt3 ~~ reap_lt3
reap_lt4 ~~ v4 *reap_lt4 
reap_lt5 ~~ v5 *reap_lt5 
reap_lt6 ~~ v6 *reap_lt6 
reap_lt7 ~~ v7 *reap_lt7 
reap_lt8 ~~ v8 *reap_lt8 
reap_lt9 ~~ v9 *reap_lt9 
reap_lt10~~ v10*reap_lt10

# covariance
# neg_lt3 ~~ reap_lt3 
# neg_lt4 ~~ reap_lt4  
# neg_lt5 ~~ reap_lt5  
# neg_lt6 ~~ reap_lt6  
# neg_lt7 ~~ reap_lt7  
# neg_lt8 ~~ reap_lt8  
# neg_lt9 ~~ reap_lt9  
# neg_lt10 ~~ reap_lt10 
'

fit <- lavaan(riclpmModel_not1t2, data = df_mod,
              missing = 'ML', #for the missing data
              int.ov.free = F,
              int.lv.free = F,
              auto.fix.first = F,
              auto.fix.single = F,
              auto.cov.lv.x = F,
              auto.cov.y = F,
              auto.var = F)
summary(fit, standardized = T)
fitMeasures(fit)


```


### Full model without time points removed
```{r}
riclpmModel <- 
'

neg_lt =~ 1*neg_t1 + 1*neg_t2 + 
          1*neg_t3 + 1*neg_t4 + 
          1*neg_t5 + 1*neg_t6 + 
          1*neg_t7 + 1*neg_t8 + 
          1*neg_t9 + 1*neg_t10
          
reap_lt =~ 1*reap_t1 + 1*reap_t2 + 
          1*reap_t3 + 1*reap_t4 + 
          1*reap_t5 + 1*reap_t6+ 
          1*reap_t7 + 1*reap_t8 + 
          1*reap_t9 + 1*reap_t10
          
#intercepts
neg_t1 ~ mu1 *1 
neg_t2 ~ mu2 *1
neg_t3 ~ mu3 *1
neg_t4 ~ mu4 *1 
neg_t5 ~ mu5 *1
neg_t6 ~ mu6 *1
neg_t7 ~ mu7 *1 
neg_t8 ~ mu8 *1
neg_t9 ~ mu9 *1
neg_t10 ~ mu3*10

reap_t1 ~ pi1 *1
reap_t2 ~ pi2 *1
reap_t3 ~ pi3 *1
reap_t4 ~ pi4 *1
reap_t5 ~ pi5 *1
reap_t6 ~ pi6 *1
reap_t7 ~ pi7 *1
reap_t8 ~ pi8 *1
reap_t9 ~ pi9 *1
reap_t10~ pi10*1

neg_lt ~~ neg_lt #variance
reap_lt ~~ reap_lt #variance
neg_lt ~~ reap_lt #covariance

# latent vars for AR and cross-lagged effects
# each factor loading set to 1
neg_lt1 =~ 1*neg_t1  
neg_lt2 =~ 1*neg_t2 
neg_lt3 =~ 1*neg_t3 
neg_lt4 =~ 1*neg_t4  
neg_lt5 =~ 1*neg_t5 
neg_lt6 =~ 1*neg_t6 
neg_lt7 =~ 1*neg_t7  
neg_lt8 =~ 1*neg_t8 
neg_lt9 =~ 1*neg_t9 
neg_lt10=~ 1*neg_t10

reap_lt1 =~ 1*reap_t1 
reap_lt2 =~ 1*reap_t2 
reap_lt3 =~ 1*reap_t3 
reap_lt4 =~ 1*reap_t4 
reap_lt5 =~ 1*reap_t5 
reap_lt6 =~ 1*reap_t6 
reap_lt7 =~ 1*reap_t7 
reap_lt8 =~ 1*reap_t8 
reap_lt9 =~ 1*reap_t9 
reap_lt10=~ 1*reap_t10


# regressions
neg_lt10 ~ alpha*neg_lt9 + beta*reap_lt10
neg_lt9  ~ alpha*neg_lt8 + beta*reap_lt9
neg_lt8  ~ alpha*neg_lt7 + beta*reap_lt8
neg_lt7  ~ alpha*neg_lt6 + beta*reap_lt7
neg_lt6  ~ alpha*neg_lt5 + beta*reap_lt6
neg_lt5  ~ alpha*neg_lt4 + beta*reap_lt5
neg_lt4  ~ alpha*neg_lt3 + beta*reap_lt4
neg_lt3  ~ alpha*neg_lt2 + beta*reap_lt3
neg_lt2  ~ alpha*neg_lt1 + beta*reap_lt2

reap_lt10 ~ delta*reap_lt9 + gamma*neg_lt9
reap_lt9  ~ delta*reap_lt8 + gamma*neg_lt8
reap_lt8  ~ delta*reap_lt7 + gamma*neg_lt7
reap_lt7  ~ delta*reap_lt6 + gamma*neg_lt6
reap_lt6  ~ delta*reap_lt5 + gamma*neg_lt5
reap_lt5  ~ delta*reap_lt4 + gamma*neg_lt4
reap_lt4  ~ delta*reap_lt3 + gamma*neg_lt3
reap_lt3  ~ delta*reap_lt2 + gamma*neg_lt2
reap_lt2  ~ delta*reap_lt1 + gamma*neg_lt1

neg_lt ~ perc_pass

# variance
neg_lt1 ~~ neg_lt1 
neg_lt2 ~~ u2*neg_lt2
neg_lt3 ~~ u3*neg_lt3
neg_lt4 ~~ u2*neg_lt4 
neg_lt5 ~~ u3*neg_lt5 
neg_lt6 ~~ u2*neg_lt6 
neg_lt7 ~~ u3*neg_lt7 
neg_lt8 ~~ u2*neg_lt8 
neg_lt9 ~~ u3*neg_lt9 
neg_lt10~~ u2*neg_lt10

reap_lt1 ~~ reap_lt1 
reap_lt2 ~~ v2*reap_lt2
reap_lt3 ~~ v3*reap_lt3
reap_lt4 ~~ v2*reap_lt4 
reap_lt5 ~~ v3*reap_lt5 
reap_lt6 ~~ v2*reap_lt6 
reap_lt7 ~~ v3*reap_lt7 
reap_lt8 ~~ v2*reap_lt8 
reap_lt9 ~~ v3*reap_lt9 
reap_lt10~~ v2*reap_lt10

# covariance
# neg_lt1 ~~ reap_lt1 
# neg_lt2 ~~ reap_lt2 
# neg_lt3 ~~ reap_lt3 
# neg_lt4 ~~ reap_lt4  
# neg_lt5 ~~ reap_lt5  
# neg_lt6 ~~ reap_lt6  
# neg_lt7 ~~ reap_lt7  
# neg_lt8 ~~ reap_lt8  
# neg_lt9 ~~ reap_lt9  
# neg_lt10~~ reap_lt10 
'

fit <- lavaan(riclpmModel, data = df_mod,
              missing = 'ML', #for the missing data
              int.ov.free = F,
              int.lv.free = F,
              auto.fix.first = F,
              auto.fix.single = F,
              auto.cov.lv.x = F,
              auto.cov.y = F,
              auto.var = F)
summary(fit, standardized = T)
fitMeasures(fit)

```





## Discussion

### Summary of Reproduction Attempt

> Open the discussion section with a paragraph summarizing the primary result from the confirmatory analysis and the assessment of whether it replicated, partially replicated, or failed to replicate the original result.

Overall, this reproduction attempt was successful. I was able to reproduce all of the model coefficients reported in Study 2 of the paper. However, I would not have been able to do this without referencing the analysis script provided online by the authors. The manuscript:
> In Model 2, we used differentiation, regulation, their cross- level interaction, and percentage passed to predict negative emotion (separately for each strategy; six models). We included lagged negative emotion (at the previous time point) to model emotional change, again excluding overnight lags. We person-mean-centered regulation and lagged emotion and grand-mean-centered differentiation and percentage passed.

By looking at the author's open analysis script online, I discovered that regulation and lagged emotion were not only person-mean-centered as reported, but subsequently grand-mean scaled as well. In addition, differentiation were not only grand-mean-centered, but also scaled by the standard deviation. This minor deviation (grand-mean-centered vs. grand-mean-scaled) also occurred in description of Model 1. That being said, these details do not substantively change or diminish the findings presented in the paper. 


### Commentary

> Add open-ended commentary (if any) reflecting (a) insights from follow-up exploratory analysis, (b) assessment of the meaning of the replication (or not) - e.g., for a failure to replicate, are the differences between original and present study ones that definitely, plausibly, or are unlikely to have been moderators of the result, and (c) discussion of any objections or challenges raised by the current and original authors about the replication attempt.  None of these need to be long.

The reproduction attempt highlighted a few lessons for me:

##### Open materials are incredibly valuable
This activity really illustrated the importance of open materials. I don't think I could have reproduced the estimates in the paper without looking at the authors' original code. Minor inconsistencies between manuscripts and the accompanying analysis pipelines are surely inevitable. This may be due to human error or it may simply be due to miscommunication between author and reader. By posting the analysis pipeline online, these inconsistencies can be resolved.

In addition, any scientist is well-acquainted with the feeling of finding something in the findings of a research report strange and wishing to investigate further. When materials are public, a reader has the opportunity to investigate these oddities further without the potentially prohibitive overhead of running a whole new study themselves. In the case of this project, I was able to dig further into strange findings regarding the acceptance strategy and come to a different interpretation than I otherwise would have been able to without the open data. In general, this type of exploratory analysis could feasibly open up whole new research programs that would have been left undiscovered if the opportunity had not been made available by the author. In this way, open data has the potential to push science forward.

##### Scaling is confusing
Scaling is a powerful tool, but opens up many degrees of freedom that could potentially inflate type 1 error. This may be a function of my own ignorance, but it seems to be pretty ambiguous when and how one should center or scale values. There are situations when one might say scaling is certainly not necessary, but oftentimes one could justify going either direction. A researcher has the option to conduct any number or combination of scaling procedures (e.g. grand-mean scaling, grand-mean centering, person-mean scaling, person-mean centering, normalization between 0-1) and these could be done on any permutation of the variables being modeled. I found it odd that the authors of this paper would person-mean center the lagged emotion variable, but not the current emotion response variable. I would personally like to see a stronger statistically backed set of guidelines for exactly when and how scaling should or should not be conducted.

##### Chance to practice RI-CLPM
This dataset provided a fun opportunity to practice the random-intercept cross lagged panel model. The RI-CLPM allows you to test bidirectional temporal relationships between variables while controlling for autoregressive effects. In addition, the addition of a participant random intercept allows you to account for stability in individuals that can inflate the estimates of your variables of interest. Prior research has shown that reappraisal is effective for attenuating negative emotion in a lasting way. Other research has shown that people prefer reappraisal for low-intensity negative emotion. The fitted RI-CLP models modeling these bidirectional relationships fit only marginally well, with the CFI, RMSEA, and SRMR all teetering just a bit past the traditional cutoffs for SEM models. That being said, there may be an issue in that many participants in these data did not have negative emotions to regulate. Therefore, theoretically, we should expect to see a curvilinear relationship where reappraisal use is low for extreme values of negative emotion and high for midrange values of negative emotion. In any event, the exercise helped me to learn how to fit a model of this sort which will be useful for my future research. 



### Analysis requirements
```{r}
sessionInfo()
```

