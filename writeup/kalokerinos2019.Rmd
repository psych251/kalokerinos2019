---
title: "Reproduction of Study 2 by Kalokerinos, Erbas, Ceulemans, & Kuppens (2019, Psychological Science)"
author: "Ashish Mehta, ashm@stanford.edu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
---


## Introduction

> [No abstract is needed.]  Each replication project will have a straightforward, no frills report of the study and results.  These reports will be publicly available as supplementary material for the aggregate report(s) of the project as a whole.  Also, to maximize project integrity, the intro and methods will be written and critiqued in advance of data collection.  Introductions can be just 1-2 paragraphs clarifying the main idea of the original study, the target finding for replication, and any other essential information.  It will NOT have a literature review -- that is in the original publication. You can write both the introduction and the methods in past tense.  

In Study 2 of the report "Differentiate to Regulate: Low Negative Emotion Differentiation Is Associated With Ineffective Use but Not Selection of Emotion-Regulation Strategies", Kalokerinos and colleagues, (2019) examined how the ability to make fine-grained distinctions between emotional states (i.e. emotion differentiation) was related to the selection and efficacy of emotion regulation (ER) strategies amidst a high-intensity emotional event. 

The authors initiated students on a nine day experience sampling method (ESM) regimen two days prior to the students receiving a highly-consequential test result. The student participants completed ten surveys per day for the nine days delivered via an application on their smart phones or via a special mobile phone provided by the experimenters. Since the present study concerns regulation *after* and emotional event, only data collected after the results were released are analyzed, resulting in 7 days of ESM data.

The data collected in each survey were:

* ratings of six discrete negative emotions (sad, angry, disappointed, ashamed, anxious, stressed) on a scale of 1-100 in response to thinking about the participant's grade on the exam

* ratings of the use of six ER strategies (rumination, distraction, reappraisal, expressive suppression, social sharing, acceptance) on a 7-point scale

* score on the students' test, (dichotimized in the analysis into passing and failing groups).

I chose to reproduce this result for two reasons. The first and primary reason is that I am collecting EMA data where I plan to do a similar type of lagged panel model. Reproducing this analysis will provide helpful practice in this type of modeling. The second reason is that I am interested in relationships between emotion differentiation abilities and emotion regulation processes. Thus, the results of this paper are of personal importance to me. 

The Github repository containing all the materials for this reproduction can be found [here](https://github.com/psych251/kalokerinos2019). The original research report PDF can be found [here](https://github.com/psych251/kalokerinos2019/blob/master/original_paper/kalokerinos2019.pdf).

## Methods

### Power Analysis

> Original effect size, power analysis for samples to achieve 80%, 90%, 95% power to detect that effect size.  Considerations of feasibility for selecting planned sample size.

neg_emo_comp_sc ~ 
    ed_score_sc*{x} +
    perc_pass_sc + 
    neg_emo_comp_lag_pc_sc +
    ({x} + neg_emo_comp_lag_pc_sc | Participant)
    
What parameters do I need to simulate data?

    
```{r}


sim1 <- function(bSex=0, bFreq=0, bSF=0, b0=1000, Vsubj=1, Vword=1, Verror=1,
                 b0, b_ed_score_sc, b_perc_pass_sc, b_neg_emo_comp_lag_pc_sc, b_er_strategy, 
                 Var_pid, Var_error, Var_slope_strategy, Var_slope_emo_lag, 
                 n=101, t=70) {
  
	subject <- rep( 1:n, each=t )
	timepoint <- rep(1:t, each=n )

	# random effects per subject
	# S.re <- rnorm(60, 0, sqrt(Vsubj))
	P_re <- rnorm(n)
	

	# epsilons
	eps <- rnorm(n*t, 0, sqrt(V_error))

	# put it all together
	ReactionTime <- b0 + bSex*(Sex=='M') + bFreq*Frequency + bSF*(Sex=='M')*Frequency +
		S.re[Subject] + W.re[Word] + eps
	
	neg_emo <- b0 + b_ed_score_sc + b_er_strategy + (b_ed_score_sc*b_er_strategy) + 
	  b_perc_pass_sc + b_neg_emo_comp_lag_pc_sc

	# put into a data frame
	mydata <- data.frame( Subject = paste('s',Subject, sep=''), 
					Word = paste('w', Word, sep=''), Sex=Sex, Frequency=Frequency,
					ReactionTime = ReactionTime)

	# analyze looking at interaction term with LR test
	fit1 <- lmer( ReactionTime ~ (Sex*Frequency) + (1|Subject) + (1|Word), data=mydata)
	fit2 <- lmer( ReactionTime ~ Sex + Frequency + (1|Subject) + (1|Word), data=mydata)
	anova(fit2,fit1)[2,7]
}
	


pb <- winProgressBar(max=100) # or tkProgressBar or txtProgressbar

setWinProgressBar(pb, 0)
out1 <- replicate( 100, {setWinProgressBar(pb, getWinProgressBar(pb)+1);
				sim1( bSex=10, bFreq=2, bSF=0.25, Vsub=4000, Vword=2500, Verror=10000)})
hist(out1)
mean( out1 < 0.05 )
```


### Sample

> Planned sample size and/or termination rule, sampling frame, known demographics if any, preselection rules if any.

The sample for this dataset consisted of first-year Belgian undergraduate students. The planned *N* was 100 participants which would have 80% power to detect a medium effect (*r* = .30, *α* = .05). The final *N* for the study was 101 participants (14 males; age: *M* = 18.64, *SD* = 1.45). Participans were recruited through a university research participation program and through social media. The authors had a predetermined rule for omission of participants with less than 50% completion, but no participants met this criterion so all were included in analysis. Participants were awarded compensation on a basis commensurate with their study completion percentage.



### Materials

> All materials - can quote directly from original article - just put the text in quotations and note that this was followed precisely.  Or, quote directly and just point out exceptions to what was described in the original article.

The materials for the study are taken directly from the original paper and copied below:

> ##### Negative emotion. 
>Six emotions (sad, angry, disappointed, ashamed, anxious, stressed) were assessed on a 100-point scale (1 = not at all, 100 = very much). The item stem was “When you think about your grades right now, how [emotion] are you feeling?” (R~KF~ = .99, R~C~ = .74). In this study, we updated this measure to include emotions relevant to the context of receiving learning outcomes (Pekrun, 2006). We kept “sad,” “angry,” “anxious,” and “stressed” from Study 1, as the former three are also learning-related emotions (Pekrun, 2006), and continuity across studies allowed for comparison. However, differentiation should replicate across the inclusion of different emotions if each of the emotions provides new information. We added “disappointed” and “ashamed” because of their centrality in retrospectively evaluating learning outcomes (Pekrun, 2006).

> ##### Negative-emotion differentiation. 
>As in Study 1, we took the ICC between negative emotions within-person across measurement occasions, applied a Fisher’s z transformation, and then reverse scored it so higher numbers equaled higher differentiation. There were no negative ICCs.

> ##### Emotion-regulation strategies. 
> We assessed six strategies on a 7-point scale (0 = not at all, 6 = very much). The item stem was “Since the last beep, have you . . .” Five strategies from Study 1 were reworded to assess grade-relevant regulation: rumination (“ruminated about your grades?”), distraction (“distracted yourself from your grades and the associated emotions?”), reappraisal (“looked at your grades or the emotions that go with them from another perspective?”), expressive suppression (“suppressed the outward expression of your emotions about your grades?”), and social sharing (“talked to others about your grades and the associated emotions?”). We also included acceptance (“accepted your emotions about your grades the way they are?”).

> ##### Percentage passed. 
> For each subject, participants reported scores out of 20, with 10 and above being a passing grade and below 10 a failing grade. Failing requires retaking the exam later in the year or, in the case of too many failures, termination of enrollment. Given the clear emotional line at passing, we dichotomized scores on each subject as fail (1–9) or pass (10–20) and calculated the percentage of subjects passed across all subjects taken. This percentage variable was highly correlated with mean score out of 20 across exams (*r* = .90), and we found no differences in reported results when using mean score instead of percentage passed. In the baseline survey, we assessed participants' expectations about their upcoming exam grades using the same measure. We used this to compute an expected-percentage-passed variable. Including both expected and actual passing percentage, or the difference between actual and expected passing percentage, did not substantively change our results. Thus, we focus on actual passing percentage.


### Procedure	

> Can quote directly from original article - just put the text in quotations and note that this was followed precisely.  Or, quote directly and just point out exceptions to what was described in the original article.

The procedure for data collection is copied from the original article below:

>Three days before receiving results, participants came to a lab session where they were trained on the ESM protocol. Participants were told that the study was about emotions and exams but were not given details about specific hypotheses. They then completed the ESM phase. On results-release day, within a 2-hr period, students were notified by e-mail that results were available in an online portal and asked to check them immediately. On this day, participants were sent a link to an online survey asking them to report their grade for each subject. For the ESM protocol, participants with a compatible personal Android phone installed mobileQ (*N* = 28). Other participants were given a research-only smartphone (*N* = 73). Participants completed 9 consecutive days of experience sampling: 2 days before the results release and 7 days after. We used a stratified random-interval scheme that sent a random signal within 10 equal intervals between 10:00 a.m. and 10:00 p.m. There was some variability in when results were released: Participants received their results between surveys 21 and 28 of 90. We were interested in regulation in response to results, and thus we included only post-results surveys, meaning that participants received between 63 and 70 surveys (*M* = 68.69). Participants received a signal on average every 71.9 min (*SD* = 29.8) and completed an average of 90.5% of signals (*SD* = 7.8%).

### Analysis Plan

> Can also quote directly, though it is less often spelled out effectively for an analysis strategy section.  The key is to report an analysis strategy that is as close to the original - data cleaning rules, data exclusion rules, covariates, etc. - as possible.  

> **Clarify key analysis of interest here**  You can also pre-specify additional analyses you plan to do.

The data analysis conducted in the original study consisted of two model structures built separately with each of the six emotion regulation strategies, resulting in twelve total models. The description of the data analytic strategy from the original article is copied below:

> #### Data-analytic strategy
> As in Study 1, we used *lme4* (Bates et al., 2015) to fit mixed-effects models and standardized variables for analyses. We ran two-level models, with measurement occasions (*N* = 6,282) nested within persons (*N* = 101). In these models, we included percentage pass as a proxy for the emotional intensity of the stimulus. However, because we did not have the necessary statistical power, we did not estimate a three-way interaction with this variable. Strategies and negative emotion were measured at the occasion level, and differentiation and percentage passed at the person level. We found no substantive differences in either model when person-level negative emotion was included, but we included this variable in Model 1 to replicate Study 1.

> ##### Model 1: emotion differentiation as a predictor of emotion-regulation strategies. 
> In Model 1, we used differentiation, percentage passed, and negative emotion, which were grand-mean centered, to predict each strategy separately (six models). We included random intercepts per participant.

> ##### Model 2: Emotion Differentiation × Emotion Regulation Strategies predicting negative emotion. 
> In Model 2, we used differentiation, regulation, their cross-level interaction, and percentage passed to predict negative emotion (separately for each strategy; six models). We included lagged negative emotion (at the previous time point) to model emotional change, again excluding overnight lags. We person-mean-centered regulation and lagged emotion and grand-mean-centered differentiation and percentage passed. We included random intercepts per participant. For each participant, we included random slopes for regulation and lagged emotion, and we allowed these slopes to covary. There was one exception to this strategy: The acceptance model would not converge until we removed the random slope for acceptance, so we report this model with this random slope omitted.

### Differences from Original Study

> Explicitly describe known differences in sample, setting, procedure, and analysis plan from original study.  The goal, of course, is to minimize those differences, but differences will inevitably occur.  Also, note whether such differences are anticipated to make a difference based on claims in the original article or subsequent published research on the conditions for obtaining the effect.

Since this is an analysis reproduction, the data will be exactly the same. I plan to run this analysis using *lme4* just as the authors did. I will also conduct the same analysis using the *brms* Bayesian Regression package in R so I can compare the credible intervals and expected values of the posterior distributions with the confidence intervals and point estimates given by the *lme4* linear mixed model framework.




### Methods Addendum (Post Data Collection)

> You can comment this section out prior to final report with data collection.

#### Actual Sample
  > Sample size, demographics, data exclusions based on rules spelled out in analysis plan

#### Differences from pre-data collection methods plan
  > Any differences from what was described as the original plan, or “none”.


## Results


### Data preparation

> Data preparation following the analysis plan.
	

#### Load Relevant Libraries and Functions
```{r}
# rm(list = ls())
library(tidyverse)
library(haven)
library(psych)
library(here)
library(broom.mixed)
library(glue)
library(lmerTest)
library(riclpmr)
library(lavaan)
theme_set(theme_minimal())

```


#### Import data
```{r}
df_raw <- read_sav(here("data/Study 2_exam.sav"))

```


#### Data exclusion / filtering
```{r}

df_raw_complete <- df_raw #%>%
  # filter(!is.na(ER_reapp))
  

```


#### Prepare data for analysis - create columns etc.

##### Column names of each emotion valence category
```{r}
neg_emo_cols <- c("emotion_sad", "emotion_angry", "emotion_disapp",
                  "emotion_ashamed", "emotion_anxious", "emotion_stressed")
pos_emo_cols <- c("emotion_proud", "emotion_happy", "emotion_content", "emotion_relief")
er_strategy_cols <- c("ER_acceptance", "ER_rumination", "ER_reapp", 
                      "ER_supp", "ER_soc_sharing", "ER_distraction")
```

##### Data munging

Here I am creating useful columns. Most of these are either grand-mean scaled (varname_sc) or centered (varname_c), person-scaled (varname_psc), or lagged (varname_lag).
```{r}
df_raw_post_exam <- df_raw_complete %>%
  # ---- Keep only reports after exam results were received ---- #
  filter(exam_beepnum >= 0)

df_clean <- df_raw_post_exam  %>% 
  # ---- Create pos/neg emotion intensity composite scores ---- #
  mutate(
    neg_emo_comp = rowMeans(df_raw_post_exam[,neg_emo_cols], na.rm = T),
    pos_emo_comp = rowMeans(df_raw_post_exam[,pos_emo_cols], na.rm = T),
    perc_pass = perc_pass*100
  ) %>% 
  # ---- Create person level mean negative emotion score (covariate in models) ---- # 
  group_by(Participant) %>% mutate(person_neg_emo_mean = mean(neg_emo_comp, na.rm = T)) %>% ungroup %>% 
  # ---- Create lagged emotion and strategy vars ---- #
  group_by(Participant, beepday) %>% 
  mutate_at(vars(matches("emo|^ER_")), list(lag = ~  lag(.))) %>% 
  ungroup %>% 
  # ---- Person scale emotion and strategy vars ---- #
  group_by(Participant) %>% 
  mutate_at(vars(matches("emo|^ER_"), -matches("_sc$|_c$|_psc$|_pc$")), list(pc = ~scale(., T, F))) %>% 
  mutate_at(vars(matches("emo|^ER_"), -matches("_sc$|_c$|_psc$|_pc$")), list(psc = ~scale(.))) %>% 
  ungroup %>% 
  # ---- Create grand mean centered emotion and strategy vars ---- #
  mutate_at(vars(matches("emo|^ER_|^perc_pass$"), 
                 -matches("_sc$|_c$")), 
            list(c = ~scale(., center=T, scale=F))) %>%
  # ---- Create grand mean scaled emotion and strategy vars ---- #
  mutate_at(vars(matches("emo|^ER_|^perc_pass$"), 
                 -matches("_sc$|_c$")), 
            list(sc = ~scale(.))) #%>%
  
  
  # mutate_at(vars(matches("emo|^ER_")), ~ifelse(all(is.na(.)), 0, .))
```



##### Function to calculate ICC stats in row form
```{r}
compute_icc <- function(dat) {
  dat %>%
    select(neg_emo_cols) %>% 
    irr::icc(model="twoway", unit = "average") %>%       
    unlist %>%        
    t %>%              
    as_tibble %>%      
    select(              
      stimuli = subjects,
      raters, 
      icc = value,       
      lbound, 
      ubound
    ) %>%
    mutate_at(vars(stimuli, raters), as.integer) %>% 
    mutate_at(vars(icc:ubound), as.numeric)
}
```

##### Create dataframe of ICCs for each participant and Fisher-z transform
```{r}
icc_df <- df_clean %>%
  group_by(Participant) %>%              
  nest() %>%                             
  mutate(icc = map(data, compute_icc)) %>%    
  unnest(icc) %>%                        
  select(-data) %>% 
  ungroup %>% 
  mutate(
    icc_fz = fisherz(icc),
    ed_score = icc_fz*-1,
    ed_score_class = case_when(
      ed_score > (mean(ed_score, na.rm = T) + sd(ed_score)) ~ "> +1 SD",
      ed_score < (mean(ed_score, na.rm = T) - sd(ed_score)) ~ "< -1 SD"
      ) 
    )
  
```

##### Merge ICC dataframe to full data
```{r}
df <- icc_df %>% 
  select(Participant, icc, ed_score, ed_score_class) %>% 
  right_join(df_clean, by="Participant") %>% 
  mutate(ed_score_sc = scale(ed_score))

```

```{r}

df <- df %>%
  filter(!is.na(ER_reapp))
  
```


### Initial data viz


##### Visualizing participant compliance
```{r}
df %>% 
  group_by(Participant) %>% 
  summarize(proportion_complete = sum(!is.na(ExecutionTime))/90) %>% 
  ungroup %>% 
  ggplot(aes(x = proportion_complete)) + 
  geom_histogram(binwidth = .02) +
  # geom_density() + 
  labs(x = "Proportion complete", x = "Number of participants")
```

#### Visualizing emotion characteristics

##### Create a long dataframe for visualizing emotion characteristics
```{r}
df_emotion_long <- df %>% 
  group_by(Participant, perc_pass) %>% 
  summarize_at(vars(starts_with("emotion_"), 
                    -matches("_c$|_sc$|_psc$|_lag|_pc$")), 
               mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -perc_pass), 
               names_to = "emotion_type", values_to = "emotion_rating") %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean)) %>% 
  left_join(select(icc_df, Participant, ed_score)) %>% 
  mutate(ed_score_class = case_when(
    ed_score > (mean(.$ed_score, na.rm = T) + sd(.$ed_score)) ~ "> +1 SD",
    ed_score < (mean(.$ed_score, na.rm = T) - sd(.$ed_score)) ~ "< -1 SD",
    TRUE ~ "</> 1 SD"
  ))
```

##### To what degree did people experience different emotions?
```{r}
df %>% 
  group_by(Participant) %>% 
  summarize_at(vars(starts_with("emotion_"), 
                    -matches("_c$|_sc$|_psc$|_lag|_pc")), 
               mean, na.rm=T) %>% 
  pivot_longer(cols = -Participant, names_to = "emotion_type", values_to = "emotion_rating") %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean)) %>% 
  
  ggplot(aes(x = emotion_type, y = emotion_rating)) +
  geom_bar(stat="summary") +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "Emotion type", y = "Mean emotion intensity")
  
```


##### How were different emotions related to the percentage of exams passed?
```{r}
df_emotion_long  %>% 
  ggplot(aes(x = perc_pass, y = emotion_rating, color = emotion_type)) +
  geom_point(aes(shape = ed_score_class), alpha = .4, position = position_dodge(w =10)) +
  geom_smooth(se=F, size = .4) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "Proportion of exams passed", 
       y = "Emotion intensity", 
       color = "", 
       size = "Differentiation score")
```

```{r, fig.asp=2}
df_emotion_long  %>% 
  ggplot(aes(x = perc_pass, y = emotion_rating, color = emotion_type)) +
  facet_grid(emotion_type ~.) +
  geom_jitter(alpha = .2) +
  geom_smooth() +
  theme(axis.text.x = element_text(angle=90)) +
  labs(y = "Emotion intensity", 
       x = "Percantage of exams passed",
       color = "")
  
```

##### How did different emotions unfold over time?
```{r}
df %>% 
  filter(exam_beepnum >= 0) %>% 
  group_by(Participant) %>% 
  ggplot(aes(x = exam_beepnum, y = neg_emo_comp)) + 
  geom_jitter(alpha = .2, size = .4) +
  geom_smooth() + 
  geom_smooth(method="lm", linetype="dotted") +
  labs(x = "EMA beep number", y = "Negative emotion mean")

perc_pass_summary <- df %>% 
  group_by(Participant) %>% 
  summarize(perc_pass = mean(perc_pass, na.rm = T)) %>% 
  summarize(mean = mean(perc_pass, na.rm = T),
            sd = sd(perc_pass, na.rm = T))

df %>% 
  # # ---- create grouping by +/- 1 SD
  # mutate(
  #   perc_pass_group = case_when(
  #     perc_pass > (perc_pass_summary$mean + perc_pass_summary$sd) ~ "high",
  #     perc_pass < (perc_pass_summary$mean - perc_pass_summary$sd) ~ "low",
  #     perc_pass < (perc_pass_summary$mean + perc_pass_summary$sd) &
  #       perc_pass > (perc_pass_summary$mean - perc_pass_summary$sd) ~"mid"
  #   )
  # ) %>% 
  # filter(perc_pass_group == "mid") %>%
  group_by(Participant, exam_beepnum) %>% 
  summarize_at(vars(starts_with("emotion_"), 
                    -matches("_sc$|_c$|_psc$|_pc$|_lag$")), 
               mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -exam_beepnum), 
               names_to = "emotion_type", 
               values_to = "emotion_rating") %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean))  %>% 
  
  ggplot(aes(x = exam_beepnum, y = emotion_rating, color = emotion_type)) +
  geom_jitter(alpha = .2, size = .1) +
  geom_smooth(se=F) +
  labs(x = "Ping number relative to exam result", y = "Emotion intensity", color = "")
```

##### Emotion over time broken down by emotion type
```{r, fig.asp=2}
df %>% 
  group_by(Participant, exam_beepnum) %>% 
  summarize_at(vars(starts_with("emotion_"), -matches("_sc$|_c$|_psc$|_pc$|_lag")), mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -exam_beepnum), names_to = "emotion_type", values_to = "emotion_rating") %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean))  %>% 
  
  ggplot(aes(x = exam_beepnum, y = emotion_rating, color = emotion_type)) +
  facet_grid(emotion_type ~.) +
  geom_jitter(alpha = .1, size = .2) +
  geom_smooth() +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "Ping number relative to exam result", y = "Emotion intensity")

```


##### What is the relationship between percentage of exams passed and negative emotion? 
Note that the variance around negative emotion increases starkly as people performed worse on exams. This could pose a problem for linear modeling.
```{r}

df %>% 
  group_by(Participant, perc_pass) %>% 
  summarize_at(vars(starts_with("emotion_"), -matches("_sc$|_c$|_psc$|_pc$|_lag")), mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -perc_pass), 
               names_to = "emotion_type", values_to = "emotion_rating") %>% 
  filter(emotion_type %in% neg_emo_cols) %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean))  %>% 
  summarize(mean_neg_emo = mean(emotion_rating),
            perc_pass = perc_pass[1]) %>% 
  
  ggplot(aes(x = perc_pass, y = mean_neg_emo)) +
  geom_jitter(alpha = .2) +
  geom_smooth() +
  labs(x = "Percentage of exams passed", y = "Mean negative emotion")
```


##### How is negative emotion differentiation related to the amount of negative emotion experienced?

This shows an interesting pattern, however, I'm not sure what to make of this since the emotion differentiation score is derived from emotion intensity.
```{r}
df %>% 
  # ---- get a mean emotion score for each emotion for each participant ---- #
  group_by(Participant, ed_score) %>% 
  summarize_at(vars(starts_with("emotion_"), 
                    -matches("_sc$|_c$|_psc$|_pc$|_lag$")),
               mean, na.rm=T) %>% 
  select(-pos_emo_cols) %>% 
  # ---- elongate ---- #
  pivot_longer(cols = c(-Participant, -ed_score), 
               names_to = "emotion_type", values_to = "emotion_rating") %>% 
  mutate(emotion_type = str_replace_all(emotion_type, "emotion_", ""),
         emotion_type = reorder(emotion_type, emotion_rating, mean)) %>% 
  
  ggplot(aes(x = ed_score, y = emotion_rating, color = emotion_type)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "loess", se=F) +
  geom_smooth(aes(group = 1), linetype = "dotted") +
  labs(y = "Emotion intensity", x = "Emotion differentiation score", color = "Negative emotion")
```


#### Visualizing regulation characteristics

##### To what degree did people use different strategies?
Acceptance has a way outsized share of strategy usage. It is difficult to measure acceptance in this context since it can easily be misintepreted as accepting your exam scores rather than accepting negative emotions. 
```{r}
df %>% 
  group_by(Participant) %>% 
  summarize_at(vars(starts_with("ER_"),
                    -matches("_sc$|_c$|_psc$|_pc$|_lag$")),
               mean, na.rm=T) %>% 
  pivot_longer(cols = -Participant, 
               names_to = "strategy_type", values_to = "strategy_rating") %>% 
  mutate(strategy_type = str_replace_all(strategy_type, "ER_", ""),
         strategy_type = reorder(strategy_type, strategy_rating, mean))  %>% 
  mutate(strategy_type=recode(strategy_type,
    "rumination" = "Rumination",
    "reapp" = "Reappraisal",
    "soc_sharing" = "Social sharing",
    "acceptance" = "Acceptance",
    "distraction" = "Distraction",
    "supp" = "Suppression"
  )) %>% 
  
  ggplot(aes(x = strategy_type, y = strategy_rating)) +
  stat_summary(fun.data = "mean_cl_boot", size = .4) +
  geom_jitter(alpha = .2, size = .5) +
  theme(axis.text.x = element_text(angle=90)) +
  scale_y_continuous(limits = c(0,6)) +
  labs(x = "", 
       y = "Mean strategy use")
  
```

##### How were different strategies related to the percentage of exams passed?
This strengthens my hypothesis that acceptance may be misinterpreted by the participants since we see a unique positive relationship with the usage of acceptance and the percentage of exams passed. We see this cluster of participants endorsing maximum acceptance usage when they passed 100% of exams and would not be expected to have any negative emotion to regulate at all. If they were misinterpreting the question to mean acceptance of their exam grade however, this pattern would be expected.
```{r}
df %>% 
  group_by(Participant, perc_pass) %>% 
  summarize_at(vars(starts_with("ER_"),
                    -matches("_sc$|_c$|_psc$|_pc$|_lag$")), 
               mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -perc_pass), 
               names_to = "strategy_type", 
               values_to = "strategy_rating") %>% 
  mutate(strategy_type = str_replace_all(strategy_type, "ER_", ""),
         strategy_type = reorder(strategy_type, strategy_rating, mean))  %>% 
  
  ggplot(aes(x = perc_pass, y = strategy_rating, color = strategy_type)) +
  geom_jitter(alpha = .2) +
  geom_smooth(method = "lm", se=F) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "Percentage of exams passed", 
       y = "Strategy usage",
       color = "Strategy")

```

##### How is mean strategy usage related to the amount of negative emotion experienced?
Again we see an anomaly in the acceptance category where the most "accepting" participants were those experiencing no negative emotion. 
```{r}
df %>% 
  group_by(Participant) %>% 
  summarize_at(vars(starts_with("ER_"),
                    -matches("_sc$|_c$|_psc$|_pc$|_lag$"),
                    neg_emo_comp), 
               mean, na.rm=T) %>% 
  pivot_longer(cols = c(-Participant, -neg_emo_comp), 
               names_to = "strategy_type", 
               values_to = "strategy_rating") %>% 
  mutate(strategy_type = str_replace_all(strategy_type, "ER_", ""),
         strategy_type = reorder(strategy_type, strategy_rating, mean))  %>% 
  
  ggplot(aes(x = neg_emo_comp, y = strategy_rating, color = strategy_type)) +
  geom_jitter(alpha = .2) +
  geom_smooth(method = "lm", se=F) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x = "Mean participant negative emotion experienced", 
       y = "Mean participant strategy usage",
       color = "Strategy")

```

Does ED score predict use of strategies?
```{r, fig.asp=1.5}
df %>% 
  pivot_longer(cols = er_strategy_cols, 
               names_to = "strategy_type", 
               values_to = "strategy_rating") %>% 
  group_by(Participant, strategy_type, ed_score) %>% 
  summarize(strategy_usage_mean = mean(strategy_rating, na.rm = T)) %>% 
  ggplot(aes(x = ed_score, y = strategy_usage_mean, color = strategy_type)) +
  # facet_grid(strategy_type~.) +
  geom_jitter(alpha = .2) +
  geom_smooth(method = "lm") +
  geom_smooth(se=F, linetype = "dashed", size = .3) +
  labs(x = "Emotion differentiation score", 
       y = "Mean strategy use",
       color = "")

```

##### How does emotion intensity at time t-1 predict ER strategy at time t?
```{r}
df %>% 
  pivot_longer(cols = er_strategy_cols, 
               names_to = "strategy_type", 
               values_to = "strategy_rating")  %>% 
  mutate(strategy_type=recode(strategy_type,
    "ER_rumination" = "Rumination",
    "ER_reapp" = "Reappraisal",
    "ER_soc_sharing" = "Social sharing",
    "ER_acceptance" = "Acceptance",
    "ER_distraction" = "Distraction",
    "ER_supp" = "Suppression"
  )) %>% 
  
  ggplot(aes(x = neg_emo_comp_lag, y = strategy_rating, color = strategy_type)) +
  # facet_grid(strategy_type~.) +
  geom_jitter(alpha = .1, size = .5) +
  geom_smooth(method = "lm") +
  geom_smooth(se=F, linetype = "dashed", size = .3) +
  labs(x = "Emotion intensity at time t-1", y = "Strategy use at time t", color = "")

```

##### how does each strategy predict negative emotion with emotion differentiation moderator?
(PLOT FROM PAPER except without using simple slopes)
```{r}

plot_df <- df %>%
  select(Participant,
         ed_score,
         ed_score_class,
         matches("ER_.*_pc_sc$"),
         -matches("_c$|_psc$|_lag|_pc$"),
         neg_emo_comp) %>%
  pivot_longer(cols = c(-Participant, -neg_emo_comp, -ed_score, -ed_score_class),
               names_to = "strategy_type",
               values_to = "strategy_rating") %>%
  mutate(
    ed_score = scale(ed_score, T, F),
    strategy_type = str_replace_all(strategy_type, "ER_", ""),
    strategy_type = reorder(strategy_type, strategy_rating, mean)) %>% 
  mutate(strategy_type=recode(strategy_type,
    "rumination_pc_sc" = "Rumination",
    "reapp_pc_sc" = "Reappraisal",
    "soc_sharing_pc_sc" = "Social sharing",
    "acceptance_pc_sc" = "Acceptance",
    "distraction_pc_sc" = "Distraction",
    "supp_pc_sc" = "Suppression"
  ))


plot_df %>%
  ggplot(aes(x = strategy_rating, y = neg_emo_comp, color = ed_score)) +
  geom_jitter(alpha = .3, size = .2) +
  geom_smooth(data=plot_df[!is.na(plot_df$ed_score_class),],
              aes(linetype = ed_score_class),
              method = "lm",
              se=F, color="black", size = .3) +
  facet_wrap(~strategy_type) +
  scale_x_continuous(breaks = seq(floor(min(plot_df$strategy_rating)), ceiling(max(plot_df$strategy_rating)), 2)) +
  scale_colour_gradient2(low = "red", mid = "lightcyan", high = "blue") +
  labs(x = "Strategy usage",
       y = "Negative emotion intensity", 
       color = "Emotion differentiation",
       linetype = "")

  
```

##### how does each strategy predict negative emotion with emotion differentiation moderator?
(PLOT FROM PAPER)
```{r}


plot_df <- df %>%
  select(Participant,
         ed_score,
         ed_score_class,
         matches("ER_.*_pc_sc$"),
         -matches("_c$|_psc$|_lag|_pc$"),
         neg_emo_comp) %>%
  pivot_longer(cols = c(-Participant, -neg_emo_comp, -ed_score, -ed_score_class),
               names_to = "strategy_type",
               values_to = "strategy_rating") %>%
  mutate(
    ed_score = scale(ed_score, T, F),
    strategy_type = str_replace_all(strategy_type, "ER_", ""),
    strategy_type = reorder(strategy_type, strategy_rating, mean)) %>% 
  mutate(strategy_type=recode(strategy_type,
    "rumination_pc_sc" = "Rumination",
    "reapp_pc_sc" = "Reappraisal",
    "soc_sharing_pc_sc" = "Social sharing",
    "acceptance_pc_sc" = "Acceptance",
    "distraction_pc_sc" = "Distraction",
    "supp_pc_sc" = "Suppression"
  )) %>% 
  filter(strategy_type %in% c("Rumination","Distraction","Acceptance","Social sharing"))


plot_df %>%
  ggplot(aes(x = strategy_rating, y = neg_emo_comp, color = ed_score)) +
  geom_jitter(alpha = .3, size = .2) +
  geom_smooth(data=plot_df[!is.na(plot_df$ed_score_class),],
              aes(linetype = ed_score_class),
              method = "lm",
              se=F, color="black", size = .3) +
  facet_wrap(~strategy_type) +
  scale_x_continuous(breaks = seq(floor(min(plot_df$strategy_rating)), ceiling(max(plot_df$strategy_rating)), 2)) +
  scale_colour_gradient2(low = "red", mid = "lightcyan", high = "blue") +
  labs(x = "Strategy usage",
       y = "Negative emotion intensity", 
       color = "Emotion differentiation",
       linetype = "")

  
```



### Confirmatory analysis

> The analyses as specified in the analysis plan.  

*Side-by-side graph with original graph is ideal here*

##### function for formatting output table
```{r}

table_out <- function(result_df){
  result_df %>% 
    filter(effect == "fixed") %>% 
    mutate(ci = glue("[{round(estimate-(std.error*1.96),2)}, {round(estimate+(std.error*1.96),2)}]")) %>% 
    select(-df, -effect, -group, -statistic) %>% 
    mutate_if(is.numeric, round, digits = 3) %>% 
    mutate(term = str_replace(term, "ed_score", "Differentiation")) %>% 
    mutate(term = str_replace(term, "_pc", "")) %>% 
    mutate(term = str_replace(term, "perc_pass", "Percentage passed")) %>% 
    mutate(term = str_replace(term, "person_neg_.*", "Negative emotion")) %>% 
    mutate(term = str_replace(term, ".*emo.*lag.*", "Lagged emotion")) %>% 
    mutate(term = str_replace(term, "ER_", "")) %>% 
    mutate(term = str_replace(term, ":", " x ")) %>% 
    mutate(term = str_replace(term, "_sc", "")) %>% 
    mutate(ordering = case_when(
      strategy == "rumination" ~ "1",
      strategy == "distraction" ~ "2",
      strategy == "reapp" ~ "3",
      strategy == "acceptance" ~ "4",
      strategy == "supp" ~ "5",
      strategy == "soc_sharing" ~ "6"
    )) %>% 
    arrange(ordering) %>% 
    select(-ordering)
}


```

##### Start the modeling ...

###### Helper function to format output of model building functions
Creates a dataframe of model parameters and a label for which strategy is being tested
```{r}
format_model <- function(x){
  x[[2]] %>% 
    broom.mixed::tidy() %>%
    mutate(strategy = x[[1]],
           strategy = str_replace(strategy, "ER_", ""),
           strategy = str_replace(strategy, "_pc_sc", "")) %>%
    select(strategy, everything())
}
```

###### Model 1: Predicting strategy selection from differentiation score
```{r}
build_model1 <- function(x){
  model_str_eval <- glue("
  lmer({x} ~ ed_score_sc + 
         perc_pass_sc + 
         person_neg_emo_mean_sc +
         (1 | Participant), df)")
  list(x, eval(parse(text = model_str_eval)))
}

result_1 <- map(paste0(er_strategy_cols, "_sc"), build_model1)
result_1_df <- map(result_1, format_model) %>% 
  bind_rows

result_1_df %>% sjPlot::tab_df(digits = 3)


result_1_out <- result_1_df %>% 
  table_out
write_csv(result_1_out, "writeup/model1_table.csv")
```

###### Model 2: Predicting efficacy from interaction of strategy usage and differentiation score
```{r}
build_model2 <- function(x){
  model_str_eval <- glue("
  lmer(neg_emo_comp_sc ~ ed_score_sc*{x} + 
  perc_pass_sc + neg_emo_comp_lag_pc_sc +
  ({x} + neg_emo_comp_lag_pc_sc | Participant), df)")
  list(x, eval(parse(text = model_str_eval)))
}


result_2 <- map(paste0(er_strategy_cols, "_pc_sc"), build_model2)
result_2_df <- map(result_2, format_model) %>% 
  bind_rows


result_2_df %>% sjPlot::tab_df(digits = 3)

result_2_out <- result_2_df %>% 
  table_out
write_csv(result_2_out, "writeup/model2_table.csv")
```

### Plotting the models (reproduction of manuscript figure)

#### Get variance-covariance matrices needed to calculate simple slopes
```{r}
# acceptance
vcov(result_2[[1]][[2]])
# rumination
vcov(result_2[[2]][[2]])
# social sharing
vcov(result_2[[5]][[2]])
# distraction
vcov(result_2[[6]][[2]])



```



<!-- #### Post-hoc power model 2 -->
<!-- ```{r} -->
<!-- library(simr) -->
<!-- reap_mod2 <- lmer( -->
<!--     neg_emo_comp_sc ~  -->
<!--     ed_score_sc*ER_reapp_pc_sc + -->
<!--     perc_pass_sc +  -->
<!--     neg_emo_comp_lag_pc_sc + -->
<!--     (ER_reapp_pc_sc + neg_emo_comp_lag_pc_sc | Participant), df)  -->
<!-- powerSim(reap_mod2, test="perc_pass_sc", nsim=100) -->

<!-- ``` -->

### Exploratory analyses

> Any follow-up analyses desired (not required).

```{r}
normalize <- function(x){
  (x - min(x, na.rm=T))/(max(x, na.rm = T)-min(x, na.rm=T))
}
```

```{r}

df_mod_long <- df %>%
  mutate(t = exam_beepnum+1,
         t_num = as.numeric(t)) %>% 
  filter(t <= 10) %>%
  select(Participant, t, t_num, perc_pass,
         # ER_reapp,
         # ER_distraction,,
         ER_rumination,
         neg_emo_comp) %>%
  mutate(t = paste0("t", t),
         neg_emo_comp = scale(neg_emo_comp),
         # ERa = scale(ER_reapp),
         # ERa = scale(ER_distraction),
         ERa = scale(ER_rumination),
         perc_pass = scale(perc_pass)) %>%
  rename("neg" = "neg_emo_comp") 

df_mod <- df_mod_long %>% 
  pivot_wider(id_cols = c("Participant", "perc_pass"),
              names_from = "t", values_from = c("neg", "ERa"))
```

```{r}
df_mod_long %>% 
  ggplot(aes(x = t_num, y = neg)) + 
  geom_jitter(alpha = .4) +
  geom_smooth(aes(group = Participant), method="gam", se = F, size = .2) +
  geom_smooth(aes(group = 1), method="gam", color = "red")

df_mod_long %>% 
  ggplot(aes(x = ERa, y = neg)) + 
  geom_jitter(alpha = .4) +
  geom_smooth(aes(group = Participant), method="gam", se = F, size = .2) +
  geom_smooth(aes(group = 1), method="gam", color = "red")

df_mod_long %>% 
  ggplot(aes(y = ERa, x = lag(neg))) + 
  geom_jitter(alpha = .4) +
  geom_smooth(aes(group = Participant), method="gam", se = F, size = .2) +
  geom_smooth(aes(group = 1), method="gam", color = "red")

# if we look at the relation between lagged neg emotion and ER it seems weird at t1 and t2 but then stays stable in the expected direction after that. I will try removing these time points from the model
df_mod_long %>% 
  ggplot(aes(y = ERa, x = lag(neg))) + 
  geom_jitter(alpha = .4) +
  geom_smooth(aes(color = t), method="gam", se = F, size = .9) #+
  # geom_smooth(aes(group = 1), method="gam", color = "red")

df_mod_long %>% 
  lmer(neg ~ ERa + lag(neg) + (1|Participant), .) %>% 
  summary
df_mod_long %>% 
  lmer(ERa ~ lag(neg) + lag(ERa) + (1|Participant), .) %>% 
  summary

```

```{r}
# df_mod <- df_mod %>% 
#   select(-contains("t1"), -contains("t2"))
```

```{r}
riclpmModel_not1t2 <- 
'
#Note, the data contain x1-3 and y1-3
#Latent mean Structure with intercepts

neg_lt =~ 1*neg_t3 + 1*neg_t4 + 
          1*neg_t5 + 1*neg_t6 + 
          1*neg_t7 + 1*neg_t8 + 
          1*neg_t9 + 1*neg_t10
          
ERa_lt =~ 1*ERa_t3 + 1*ERa_t4 + 
          1*ERa_t5 + 1*ERa_t6+ 
          1*ERa_t7 + 1*ERa_t8 + 
          1*ERa_t9 + 1*ERa_t10
          
#intercepts
neg_t3 ~ mu3 *1
neg_t4 ~ mu4 *1 
neg_t5 ~ mu5 *1
neg_t6 ~ mu6 *1
neg_t7 ~ mu7 *1 
neg_t8 ~ mu8 *1
neg_t9 ~ mu9 *1
neg_t10 ~ mu10*10

ERa_t3 ~ pi3 *1
ERa_t4 ~ pi4 *1
ERa_t5 ~ pi5 *1
ERa_t6 ~ pi6 *1
ERa_t7 ~ pi7 *1
ERa_t8 ~ pi8 *1
ERa_t9 ~ pi9 *1
ERa_t10~ pi10*1

neg_lt ~~ neg_lt #variance
ERa_lt ~~ ERa_lt #variance
neg_lt ~~ ERa_lt #covariance

# latent vars for AR and cross-lagged effects
# each factor loading set to 1
neg_lt3 =~ 1*neg_t3 
neg_lt4 =~ 1*neg_t4  
neg_lt5 =~ 1*neg_t5 
neg_lt6 =~ 1*neg_t6 
neg_lt7 =~ 1*neg_t7  
neg_lt8 =~ 1*neg_t8 
neg_lt9 =~ 1*neg_t9 
neg_lt10=~ 1*neg_t10

ERa_lt3 =~ 1*ERa_t3 
ERa_lt4 =~ 1*ERa_t4 
ERa_lt5 =~ 1*ERa_t5 
ERa_lt6 =~ 1*ERa_t6 
ERa_lt7 =~ 1*ERa_t7 
ERa_lt8 =~ 1*ERa_t8 
ERa_lt9 =~ 1*ERa_t9 
ERa_lt10=~ 1*ERa_t10


# regressions
neg_lt10 ~ alpha*neg_lt9 + beta*ERa_lt10
neg_lt9  ~ alpha*neg_lt8 + beta*ERa_lt9
neg_lt8  ~ alpha*neg_lt7 + beta*ERa_lt8
neg_lt7  ~ alpha*neg_lt6 + beta*ERa_lt7
neg_lt6  ~ alpha*neg_lt5 + beta*ERa_lt6
neg_lt5  ~ alpha*neg_lt4 + beta*ERa_lt5
neg_lt4  ~ alpha*neg_lt3 + beta*ERa_lt4

ERa_lt10 ~ delta*ERa_lt9 + gamma*neg_lt9
ERa_lt9  ~ delta*ERa_lt8 + gamma*neg_lt8
ERa_lt8  ~ delta*ERa_lt7 + gamma*neg_lt7
ERa_lt7  ~ delta*ERa_lt6 + gamma*neg_lt6
ERa_lt6  ~ delta*ERa_lt5 + gamma*neg_lt5
ERa_lt5  ~ delta*ERa_lt4 + gamma*neg_lt4
ERa_lt4  ~ delta*ERa_lt3 + gamma*neg_lt3

neg_lt ~ perc_pass

# variance
neg_lt3 ~~ neg_lt3
neg_lt4 ~~ u4 *neg_lt4 
neg_lt5 ~~ u5 *neg_lt5 
neg_lt6 ~~ u6 *neg_lt6 
neg_lt7 ~~ u7 *neg_lt7 
neg_lt8 ~~ u8 *neg_lt8 
neg_lt9 ~~ u9 *neg_lt9 
neg_lt10~~ u10*neg_lt10

ERa_lt3 ~~ ERa_lt3
ERa_lt4 ~~ v4 *ERa_lt4 
ERa_lt5 ~~ v5 *ERa_lt5 
ERa_lt6 ~~ v6 *ERa_lt6 
ERa_lt7 ~~ v7 *ERa_lt7 
ERa_lt8 ~~ v8 *ERa_lt8 
ERa_lt9 ~~ v9 *ERa_lt9 
ERa_lt10~~ v10*ERa_lt10

# covariance
neg_lt3 ~~ ERa_lt3 
neg_lt4 ~~ ERa_lt4  
neg_lt5 ~~ ERa_lt5  
neg_lt6 ~~ ERa_lt6  
neg_lt7 ~~ ERa_lt7  
neg_lt8 ~~ ERa_lt8  
neg_lt9 ~~ ERa_lt9  
neg_lt10 ~~ ERa_lt10 
'

fit <- lavaan(riclpmModel_not1t2, data = df_mod,
              missing = 'ML', #for the missing data!
              int.ov.free = F,
              int.lv.free = F,
              auto.fix.first = F,
              auto.fix.single = F,
              auto.cov.lv.x = F,
              auto.cov.y = F,
              auto.var = F)
summary(fit, standardized = T)
fitMeasures(fit)

```

```{r}
#get the model-expected means
means <- fitted(fit)$mean
meansDF <- data.frame(mean = means, key = names(means)) %>%
  extract(col = key, into = c('var', 't'), regex = '(\\w)(\\d)')

df_mod_long2 <- df_mod %>% 
  pivot_longer(cols = c(-Participant, -perc_pass),
               names_to = "var", values_to = "value") %>% 
  separate(var, c("var", "t")) %>% 
  # pivot_wider(names_from = "var", values_from = "value") %>% 
  mutate(pid = 1:n()) #%>%
  # select(-Participant)

#plot the model-expected random intercepts
predict(fit) %>%
  as.data.frame %>%
  # mutate(pid = 1:n()) %>%
  mutate(Participant = df_mod$Participant)
  gather(key, latentvalue, -pid, -neg_lt, -ERa_lt) %>%
  extract(col = key, into = c('latentvar', 't'), regex = '(\\w)(\\d)') %>%
  mutate(var = c(p = 'neg_lt', q = 'ERa_lt')[latentvar]) %>%
  left_join(meansDF) %>% #those means from above
  left_join(df_mod_long2, by = c('pid', 't', 'var')) %>% #the raw data
  mutate(expectedLine = ifelse(var == 'x', kappa, omega) + mean,
         wave = as.numeric(t)) %>%
  rowwise() %>%
  ggplot(aes(x = wave, y = expectedLine, color = var, group = var)) +
  geom_point(aes(x = wave, y = value, 
                 group = interaction(var, Participant)), alpha = .1, position = position_jitter(w = .2, h = 0)) +
  geom_line(aes(y = expectedLine, 
                group = interaction(var, Participant)), 
            stat = 'identity', alpha = .1) + 
  geom_line(aes(y = mean), stat = 'identity', alpha = 1, size = 1, color = 'black') + 
  facet_wrap(~var, ncol = 2) + 
  theme_classic()
```
```{r}
library(GGally)
predict(fit) %>%
  as.data.frame %>%
  select(-neg_lt, -ERa_lt) %>%
  ggpairs(lower = list(continuous = wrap(ggally_smooth, alpha = .5))) + 
  theme_classic()

df_mod %>% 
  # select(-x4, -y4) %>%
  ggpairs(lower = list(continuous = wrap(ggally_smooth, alpha = .5))) + 
  theme_classic()

```


### Full model without time points removed
```{r}
riclpmModel <- 
'
#Note, the data contain x1-3 and y1-3
#Latent mean Structure with intercepts

neg_lt =~ 1*neg_t1 + 1*neg_t2 + 
          1*neg_t3 + 1*neg_t4 + 
          1*neg_t5 + 1*neg_t6 + 
          1*neg_t7 + 1*neg_t8 + 
          1*neg_t9 + 1*neg_t10
          
ERa_lt =~ 1*ERa_t1 + 1*ERa_t2 + 
          1*ERa_t3 + 1*ERa_t4 + 
          1*ERa_t5 + 1*ERa_t6+ 
          1*ERa_t7 + 1*ERa_t8 + 
          1*ERa_t9 + 1*ERa_t10
          
#intercepts
neg_t1 ~ mu1 *1 
neg_t2 ~ mu2 *1
neg_t3 ~ mu3 *1
neg_t4 ~ mu4 *1 
neg_t5 ~ mu5 *1
neg_t6 ~ mu6 *1
neg_t7 ~ mu7 *1 
neg_t8 ~ mu8 *1
neg_t9 ~ mu9 *1
neg_t10 ~ mu3*10

ERa_t1 ~ pi1 *1
ERa_t2 ~ pi2 *1
ERa_t3 ~ pi3 *1
ERa_t4 ~ pi4 *1
ERa_t5 ~ pi5 *1
ERa_t6 ~ pi6 *1
ERa_t7 ~ pi7 *1
ERa_t8 ~ pi8 *1
ERa_t9 ~ pi9 *1
ERa_t10~ pi10*1

neg_lt ~~ neg_lt #variance
ERa_lt ~~ ERa_lt #variance
neg_lt ~~ ERa_lt #covariance

# latent vars for AR and cross-lagged effects
# each factor loading set to 1
neg_lt1 =~ 1*neg_t1  
neg_lt2 =~ 1*neg_t2 
neg_lt3 =~ 1*neg_t3 
neg_lt4 =~ 1*neg_t4  
neg_lt5 =~ 1*neg_t5 
neg_lt6 =~ 1*neg_t6 
neg_lt7 =~ 1*neg_t7  
neg_lt8 =~ 1*neg_t8 
neg_lt9 =~ 1*neg_t9 
neg_lt10=~ 1*neg_t10

ERa_lt1 =~ 1*ERa_t1 
ERa_lt2 =~ 1*ERa_t2 
ERa_lt3 =~ 1*ERa_t3 
ERa_lt4 =~ 1*ERa_t4 
ERa_lt5 =~ 1*ERa_t5 
ERa_lt6 =~ 1*ERa_t6 
ERa_lt7 =~ 1*ERa_t7 
ERa_lt8 =~ 1*ERa_t8 
ERa_lt9 =~ 1*ERa_t9 
ERa_lt10=~ 1*ERa_t10


# regressions
neg_lt10 ~ alpha*neg_lt9 + beta*ERa_lt10
neg_lt9  ~ alpha*neg_lt8 + beta*ERa_lt9
neg_lt8  ~ alpha*neg_lt7 + beta*ERa_lt8
neg_lt7  ~ alpha*neg_lt6 + beta*ERa_lt7
neg_lt6  ~ alpha*neg_lt5 + beta*ERa_lt6
neg_lt5  ~ alpha*neg_lt4 + beta*ERa_lt5
neg_lt4  ~ alpha*neg_lt3 + beta*ERa_lt4
neg_lt3  ~ alpha*neg_lt2 + beta*ERa_lt3
neg_lt2  ~ alpha*neg_lt1 + beta*ERa_lt2

ERa_lt10 ~ delta*ERa_lt9 + gamma*neg_lt9
ERa_lt9  ~ delta*ERa_lt8 + gamma*neg_lt8
ERa_lt8  ~ delta*ERa_lt7 + gamma*neg_lt7
ERa_lt7  ~ delta*ERa_lt6 + gamma*neg_lt6
ERa_lt6  ~ delta*ERa_lt5 + gamma*neg_lt5
ERa_lt5  ~ delta*ERa_lt4 + gamma*neg_lt4
ERa_lt4  ~ delta*ERa_lt3 + gamma*neg_lt3
ERa_lt3  ~ delta*ERa_lt2 + gamma*neg_lt2
ERa_lt2  ~ delta*ERa_lt1 + gamma*neg_lt1

neg_lt ~ perc_pass

# variance
neg_lt1 ~~ neg_lt1 
neg_lt2 ~~ u2*neg_lt2
neg_lt3 ~~ u3*neg_lt3
neg_lt4 ~~ u2*neg_lt4 
neg_lt5 ~~ u3*neg_lt5 
neg_lt6 ~~ u2*neg_lt6 
neg_lt7 ~~ u3*neg_lt7 
neg_lt8 ~~ u2*neg_lt8 
neg_lt9 ~~ u3*neg_lt9 
neg_lt10~~ u2*neg_lt10

ERa_lt1 ~~ ERa_lt1 
ERa_lt2 ~~ v2*ERa_lt2
ERa_lt3 ~~ v3*ERa_lt3
ERa_lt4 ~~ v2*ERa_lt4 
ERa_lt5 ~~ v3*ERa_lt5 
ERa_lt6 ~~ v2*ERa_lt6 
ERa_lt7 ~~ v3*ERa_lt7 
ERa_lt8 ~~ v2*ERa_lt8 
ERa_lt9 ~~ v3*ERa_lt9 
ERa_lt10~~ v2*ERa_lt10

# covariance
neg_lt1 ~~ ERa_lt1 
neg_lt2 ~~ ERa_lt2 
neg_lt3 ~~ ERa_lt3 
neg_lt4 ~~ ERa_lt4  
neg_lt5 ~~ ERa_lt5  
neg_lt6 ~~ ERa_lt6  
neg_lt7 ~~ ERa_lt7  
neg_lt8 ~~ ERa_lt8  
neg_lt9 ~~ ERa_lt9  
neg_lt10~~ ERa_lt10 
'

fit <- lavaan(riclpmModel, data = df_mod,
              missing = 'ML', #for the missing data!
              int.ov.free = F,
              int.lv.free = F,
              auto.fix.first = F,
              auto.fix.single = F,
              auto.cov.lv.x = F,
              auto.cov.y = F,
              auto.var = F)
summary(fit, standardized = T)
fitMeasures(fit)

```





## Discussion

### Summary of Replication Attempt

> Open the discussion section with a paragraph summarizing the primary result from the confirmatory analysis and the assessment of whether it replicated, partially replicated, or failed to replicate the original result.  

### Commentary

> Add open-ended commentary (if any) reflecting (a) insights from follow-up exploratory analysis, (b) assessment of the meaning of the replication (or not) - e.g., for a failure to replicate, are the differences between original and present study ones that definitely, plausibly, or are unlikely to have been moderators of the result, and (c) discussion of any objections or challenges raised by the current and original authors about the replication attempt.  None of these need to be long.

### Analysis requirements
```{r}
sessionInfo()
```

